{% extends "base.html" %}

{% block title %}血糖数据 - Nightscout 血糖监控{% endblock %}

{% block content %}
<div class="row">
    <!-- 控制面板 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt"></i> 控制面板
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-12 col-xl-7 mb-3 mb-xl-0">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-primary active btn-sm" onclick="loadData(1)">今日</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(3)">3日</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(7)">7日</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(15)">15日</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(30)">30日</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(60)">60日</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(90)">90日</button>
                            <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="collapse" data-bs-target="#customDateCollapse">自定义</button>
                        </div>
                    </div>
                    <div class="col-12 col-xl-5">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button class="btn btn-primary btn-sm" onclick="generateReport()">
                                <i class="fas fa-file-alt"></i> <span class="d-none d-sm-inline">生成报表</span>
                            </button>
                            <button class="btn btn-success btn-sm" onclick="getAnalysis()">
                                <i class="fas fa-brain"></i> <span class="d-none d-sm-inline">AI分析</span>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="openAIConsult()">
                                <i class="fas fa-comments"></i> <span class="d-none d-sm-inline">AI咨询</span>
                            </button>
                            <button class="btn btn-info btn-sm" onclick="openMessageInbox()">
                                <i class="fas fa-envelope"></i> <span class="d-none d-sm-inline">消息记录</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义日期选择 -->
    <div class="col-12 mb-4">
        <div class="collapse" id="customDateCollapse">
            <div class="card card-body">
                <div class="row align-items-end">
                    <div class="col-md-5 mb-2 mb-md-0">
                        <label for="startDate" class="form-label">开始日期</label>
                        <input type="date" id="startDate" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-5 mb-2 mb-md-0">
                        <label for="endDate" class="form-label">结束日期</label>
                        <input type="date" id="endDate" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary btn-sm w-100" onclick="loadCustomDateRange()">查询</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="col-12 mb-4">
        <div class="row" id="stats-cards">
            <div class="col-6 col-xl-2 col-lg-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-primary mb-2">平均血糖</h6>
                        <h4 id="avg-glucose" class="mb-1">--</h4>
                        <small class="text-muted">mmol/L</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-success mb-2">目标范围内</h6>
                        <h4 id="in-range" class="mb-1">--</h4>
                        <small class="text-muted">%</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-warning mb-2">最高血糖</h6>
                        <h4 id="max-glucose" class="mb-1">--</h4>
                        <small class="text-muted">mmol/L</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-danger mb-2">最低血糖</h6>
                        <h4 id="min-glucose" class="mb-1">--</h4>
                        <small class="text-muted">mmol/L</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-6 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-info mb-2">糖化血红蛋白</h6>
                        <h4 id="hba1c-value" class="mb-1">--</h4>
                        <small id="hba1c-unit" class="text-muted">%</small>
                        <div id="hba1c-status" class="mt-1">
                            <small class="badge bg-secondary">--</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-6 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-purple mb-2">血糖变异系数</h6>
                        <h4 id="cv-value" class="mb-1">--</h4>
                        <small class="text-muted">%</small>
                        <div id="cv-status" class="mt-1">
                            <small class="badge bg-secondary">--</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 血糖图表 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line"></i> 血糖趋势图
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="glucoseChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 血糖数据表格 -->
    <div class="col-12 col-xl-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table"></i> 血糖数据
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="sticky-header">
                            <tr>
                                <th class="d-none d-sm-table-cell">时间</th>
                                <th class="d-sm-none">时间/血糖</th>
                                <th class="d-none d-sm-table-cell">血糖值 (mmol/L)</th>
                                <th class="d-none d-md-table-cell">血糖值 (mg/dL)</th>
                                <th class="d-none d-sm-table-cell">趋势</th>
                            </tr>
                        </thead>
                        <tbody id="glucose-table-body">
                            <tr>
                                <td colspan="4" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> 加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 治疗数据表格 -->
    <div class="col-12 col-xl-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-utensils"></i> 餐食记录
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="sticky-header">
                            <tr>
                                <th class="d-none d-sm-table-cell">时间</th>
                                <th class="d-sm-none">时间/营养</th>
                                <th class="d-none d-sm-table-cell">营养成分</th>
                                <th class="d-none d-md-table-cell">类型/备注</th>
                            </tr>
                        </thead>
                        <tbody id="treatment-table-body">
                            <tr>
                                <td colspan="3" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> 加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 运动数据表格 -->
    <div class="col-12 col-xl-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-running"></i> 运动记录
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="sticky-header">
                            <tr>
                                <th class="d-none d-sm-table-cell">时间</th>
                                <th class="d-sm-none">时间/运动</th>
                                <th class="d-none d-sm-table-cell">运动类型</th>
                                <th class="d-none d-md-table-cell">时长/备注</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table-body">
                            <tr>
                                <td colspan="3" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> 加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 指尖血糖数据表格 -->
    <div class="col-12 col-xl-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tint"></i> 指尖血糖记录
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="sticky-header">
                            <tr>
                                <th class="d-none d-sm-table-cell">时间</th>
                                <th class="d-sm-none">时间/血糖</th>
                                <th class="d-none d-sm-table-cell">血糖值</th>
                                <th class="d-none d-md-table-cell">同时间CGM血糖值</th>
                            </tr>
                        </thead>
                        <tbody id="meter-table-body">
                            <tr>
                                <td colspan="3" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> 加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI分析模态框 -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-brain"></i> AI血糖分析报告
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysis-content">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 分析中，请稍候...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="copyAnalysis()">
                    <i class="fas fa-copy"></i> 复制分析
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI咨询模态框 -->
<div class="modal fade" id="consultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-comments"></i> AI血糖咨询
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="consultQuestion" class="form-label">请输入您的问题：</label>
                    <textarea class="form-control" id="consultQuestion" rows="3"
                              placeholder="例如：我今天的血糖波动大吗？应该注意什么？"></textarea>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeGlucoseData" checked>
                        <label class="form-check-label" for="includeGlucoseData">
                            附带血糖信息作为上下文
                        </label>
                    </div>
                </div>
                <div id="consult-response" style="display: none;">
                    <hr>
                    <h6><i class="fas fa-robot"></i> AI回复：</h6>
                    <div id="consult-content" class="border rounded p-3 bg-light">
                        <!-- AI回复内容 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="submitConsult()" id="consultSubmitBtn">
                    <i class="fas fa-paper-plane"></i> 提交咨询
                </button>
                <button type="button" class="btn btn-success" onclick="copyConsultResponse()" id="copyConsultBtn" style="display: none;">
                    <i class="fas fa-copy"></i> 复制回复
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentDays = 7;
    let glucoseChart = null;
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 设置自定义日期选择器的默认值
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
        document.getElementById('startDate').value = sevenDaysAgo.toISOString().split('T')[0];

        // 先同步数据，然后加载显示
        syncDataAndLoadToday();
        
        // 更新未读消息数量
        updateUnreadCountIndicator();
    });

    // 同步数据并加载（页面加载时使用）
    function syncDataAndLoad() {
        // 静默同步，不显示成功提示
        fetch('/api/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({days: 7})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 只在控制台记录成功信息，不显示通知
                console.log(`同步成功！获取到 ${data.glucose_count} 条血糖数据和 ${data.treatment_count} 条治疗数据`);
                // 同步成功后加载数据
                loadData(7);
            } else {
                showNotification('同步失败: ' + data.error, 'warning');
                // 即使同步失败也尝试加载本地数据
                loadData(7);
            }
        })
        .catch(error => {
            console.error('同步失败:', error);
            showNotification('同步失败: ' + error.message, 'warning');
            // 同步失败也加载本地数据
            loadData(7);
        });
    }
    
    // 同步数据并加载今日数据（页面加载时使用）
    function syncDataAndLoadToday() {
        // 静默同步，不显示成功提示
        fetch('/api/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({days: 1})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 只在控制台记录成功信息，不显示通知
                console.log(`同步成功！获取到 ${data.glucose_count} 条血糖数据和 ${data.treatment_count} 条治疗数据`);
                // 同步成功后加载数据
                loadData(1);
            } else {
                showNotification('同步失败: ' + data.error, 'warning');
                // 即使同步失败也尝试加载本地数据
                loadData(1);
            }
        })
        .catch(error => {
            console.error('同步失败:', error);
            showNotification('同步失败: ' + error.message, 'warning');
            // 同步失败也加载本地数据
            loadData(1);
        });
    }
    
    // 更新按钮激活状态
    function updateActiveButton(targetButton) {
        document.querySelectorAll('.btn-group .btn, [data-bs-target="#customDateCollapse"]').forEach(btn => {
            btn.classList.remove('active', 'btn-primary');
            if (!btn.classList.contains('btn-outline-info')) {
                 btn.classList.add('btn-outline-primary');
            }
        });
        
        if (targetButton) {
            targetButton.classList.remove('btn-outline-primary', 'btn-outline-info');
            targetButton.classList.add('btn-primary', 'active');
        }
    }

    // 加载数据（按天数）
    function loadData(days) {
        currentDays = days;
        const url = `?days=${days}`;
        fetchAndLoadData(url);
        
        // 更新按钮状态
        const buttons = document.querySelectorAll('.btn-group .btn');
        const btnDays = [1, 3, 7, 15, 30, 60, 90];
        const buttonIndex = btnDays.indexOf(days);
        if (buttonIndex !== -1) {
            updateActiveButton(buttons[buttonIndex]);
        }
    }

    // 加载数据（按自定义日期）
    function loadCustomDateRange() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
            showNotification('请选择开始和结束日期', 'warning');
            return;
        }
        if (new Date(startDate) > new Date(endDate)) {
            showNotification('开始日期不能晚于结束日期', 'warning');
            return;
        }

        const url = `?start_date=${startDate}&end_date=${endDate}`;
        fetchAndLoadData(url);
        
        // 更新按钮状态
        const customButton = document.querySelector('[data-bs-target="#customDateCollapse"]');
        updateActiveButton(customButton);
    }

    // 核心数据获取和加载函数
    function fetchAndLoadData(urlParams) {
        // 加载血糖数据
        fetch(`/api/glucose-data${urlParams}`)
            .then(response => response.json())
            .then(glucoseData => {
                updateGlucoseTable(glucoseData);
                
                // 并行加载餐食和运动数据，然后更新图表
                Promise.all([
                    fetch(`/api/treatment-data${urlParams}`).then(response => response.json()),
                    fetch(`/api/activity-data${urlParams}`).then(response => response.json())
                ]).then(([treatmentData, activityData]) => {
                    updateGlucoseChart(glucoseData, treatmentData, activityData);
                }).catch(error => {
                    console.error('加载餐食或运动数据失败:', error);
                    // 即使餐食/运动数据加载失败，也只显示血糖数据
                    updateGlucoseChart(glucoseData, [], []);
                });
            })
            .catch(error => {
                console.error('加载血糖数据失败:', error);
                showNotification('加载血糖数据失败', 'danger');
            });

        // 加载统计数据
        fetch(`/api/statistics${urlParams}`)
            .then(response => response.json())
            .then(data => {
                updateStats(data);
            })
            .catch(error => {
                console.error('加载统计数据失败:', error);
                updateStats({});
            });
        
        // 加载治疗数据
        fetch(`/api/treatment-data${urlParams}`)
            .then(response => response.json())
            .then(data => {
                updateTreatmentTable(data);
            })
            .catch(error => {
                console.error('加载治疗数据失败:', error);
                showNotification('加载治疗数据失败', 'danger');
            });

        // 加载运动数据
        fetch(`/api/activity-data${urlParams}`)
            .then(response => response.json())
            .then(data => {
                updateActivityTable(data);
            })
            .catch(error => {
                console.error('加载运动数据失败:', error);
                showNotification('加载运动数据失败', 'danger');
            });

        // 加载指尖血糖数据
        fetch(`/api/meter-data${urlParams}`)
            .then(response => response.json())
            .then(data => {
                updateMeterTable(data);
            })
            .catch(error => {
                console.error('加载指尖血糖数据失败:', error);
                showNotification('加载指尖血糖数据失败', 'danger');
            });
    }
    
    // 更新血糖表格
    function updateGlucoseTable(data) {
        const tbody = document.getElementById('glucose-table-body');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暂无数据</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(item => {
            // 移动端合并显示
            const mobileContent = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${item.time.split(' ')[1]}</div>
                        <small class="text-muted">${item.time.split(' ')[0]}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold ${getGlucoseColor(item.value_mmol)}">${formatGlucoseValue(item.value_mmol)} mmol/L</div>
                        <small class="text-muted">${item.value_mgdl} mg/dL ${formatDirection(item.direction)}</small>
                    </div>
                </div>
            `;

            return `
                <tr>
                    <td class="d-none d-sm-table-cell">${item.time}</td>
                    <td class="d-sm-none">${mobileContent}</td>
                    <td class="d-none d-sm-table-cell ${getGlucoseColor(item.value_mmol)}">${formatGlucoseValue(item.value_mmol)}</td>
                    <td class="d-none d-md-table-cell">${item.value_mgdl}</td>
                    <td class="d-none d-sm-table-cell">${formatDirection(item.direction)}</td>
                </tr>
            `;
        }).join('');
    }

    // 获取血糖值颜色
    function getGlucoseColor(value) {
        if (value < 3.9) return 'text-danger';
        if (value > 10.0) return 'text-warning';
        return 'text-success';
    }
    
    // 更新治疗表格
    function updateTreatmentTable(data) {
        const tbody = document.getElementById('treatment-table-body');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">暂无数据</td></tr>';
            return;
        }

        // 过滤有营养成分的数据（碳水、蛋白质或脂肪任一大于0）
        const filteredData = data.filter(item =>
            (item.carbs && item.carbs > 0) ||
            (item.protein && item.protein > 0) ||
            (item.fat && item.fat > 0) ||
            item.event_type === 'Carb Correction' ||
            item.event_type === 'Meal Bolus'
        );

        tbody.innerHTML = filteredData.map(item => {
            // 构建营养成分显示
            const nutritionParts = [];
            if (item.carbs && item.carbs > 0) {
                nutritionParts.push(`<span class="badge bg-primary me-1">${item.carbs}g碳水</span>`);
            }
            if (item.protein && item.protein > 0) {
                nutritionParts.push(`<span class="badge bg-success me-1">${item.protein}g蛋白质</span>`);
            }
            if (item.fat && item.fat > 0) {
                nutritionParts.push(`<span class="badge bg-warning me-1">${item.fat}g脂肪</span>`);
            }

            // 如果没有营养成分但是相关事件类型，显示事件类型
            const nutritionDisplay = nutritionParts.length > 0
                ? nutritionParts.join('')
                : `<span class="text-muted">${item.event_type || '无营养数据'}</span>`;

            // 构建类型/备注显示
            const typeAndNotes = [];
            if (item.event_type && item.event_type !== 'Meal Bolus') {
                typeAndNotes.push(item.event_type);
            }
            if (item.notes) {
                typeAndNotes.push(item.notes);
            }
            const typeDisplay = typeAndNotes.length > 0 ? typeAndNotes.join(' - ') : '-';

            // 移动端合并显示
            const mobileContent = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold">${item.time.split(' ')[1]}</div>
                        <small class="text-muted">${item.time.split(' ')[0]}</small>
                    </div>
                    <div class="text-end">
                        <div class="mb-1">${nutritionDisplay}</div>
                        <small class="text-muted">${typeDisplay}</small>
                    </div>
                </div>
            `;

            return `
                <tr>
                    <td class="d-none d-sm-table-cell">${item.time}</td>
                    <td class="d-sm-none">${mobileContent}</td>
                    <td class="d-none d-sm-table-cell">${nutritionDisplay}</td>
                    <td class="d-none d-md-table-cell">${typeDisplay}</td>
                </tr>
            `;
        }).join('');
    }

    // 更新运动表格
    function updateActivityTable(data) {
        const tbody = document.getElementById('activity-table-body');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">暂无数据</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(item => {
            // 构建时长显示
            const durationDisplay = item.duration > 0 ? `${item.duration}分钟` : '-';
            
            // 构建类型/备注显示
            const typeAndNotes = [];
            if (item.event_type) {
                typeAndNotes.push(item.event_type);
            }
            if (item.notes) {
                typeAndNotes.push(item.notes);
            }
            const typeDisplay = typeAndNotes.length > 0 ? typeAndNotes.join(' - ') : '-';

            // 移动端合并显示
            const mobileContent = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold">${item.time.split(' ')[1]}</div>
                        <small class="text-muted">${item.time.split(' ')[0]}</small>
                    </div>
                    <div class="text-end">
                        <div class="mb-1">${item.event_type || '运动'}</div>
                        <small class="text-muted">${durationDisplay} ${typeDisplay !== '-' ? typeDisplay : ''}</small>
                    </div>
                </div>
            `;

            return `
                <tr>
                    <td class="d-none d-sm-table-cell">${item.time}</td>
                    <td class="d-sm-none">${mobileContent}</td>
                    <td class="d-none d-sm-table-cell">${item.event_type || '运动'}</td>
                    <td class="d-none d-md-table-cell">${durationDisplay} ${typeDisplay !== '-' ? `<br><small class="text-muted">${typeDisplay}</small>` : ''}</td>
                </tr>
            `;
        }).join('');
    }

    // 更新指尖血糖表格
    function updateMeterTable(data) {
        const tbody = document.getElementById('meter-table-body');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">暂无数据</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(item => {
            // 获取血糖值颜色
            const glucoseColor = getGlucoseColor(item.value_mmol);
            const cgmGlucoseColor = item.cgm_value_mmol ? getGlucoseColor(item.cgm_value_mmol) : 'text-muted';
            const cgmValueDisplay = item.cgm_value_mmol ? formatGlucoseValue(item.cgm_value_mmol) : 'N/A';

            // 移动端合并显示
            const mobileContent = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold">${item.time.split(' ')[1]}</div>
                        <small class="text-muted">${item.time.split(' ')[0]}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold ${glucoseColor}">指尖: ${formatGlucoseValue(item.value_mmol)} mmol/L</div>
                        <small class="${cgmGlucoseColor}">CGM: ${cgmValueDisplay} mmol/L</small>
                    </div>
                </div>
            `;

            return `
                <tr>
                    <td class="d-none d-sm-table-cell">${item.time}</td>
                    <td class="d-sm-none">${mobileContent}</td>
                    <td class="d-none d-sm-table-cell ${glucoseColor}">${formatGlucoseValue(item.value_mmol)}</td>
                    <td class="d-none d-md-table-cell ${cgmGlucoseColor}">${cgmValueDisplay}</td>
                </tr>
            `;
        }).join('');
    }
    
    // 更新统计信息
    function updateStats(data) {
        // 基础统计数据
        document.getElementById('avg-glucose').textContent = data.avg_glucose || '--';
        document.getElementById('in-range').textContent = data.in_range_percentage || '--';
        document.getElementById('max-glucose').textContent = data.max_glucose || '--';
        document.getElementById('min-glucose').textContent = data.min_glucose || '--';

        // 糖化血红蛋白
        if (data.hba1c_data && data.hba1c_data.hba1c_adag_percent) {
            const hba1c = data.hba1c_data.hba1c_adag_percent;
            const hba1cMmol = data.hba1c_data.hba1c_adag_mmol;

            document.getElementById('hba1c-value').textContent = hba1c;
            document.getElementById('hba1c-unit').textContent = `% (${hba1cMmol} mmol/mol)`;

            // 设置状态标签和颜色
            const statusElement = document.getElementById('hba1c-status');
            let statusText = '';
            let statusClass = '';

            if (hba1c < 5.7) {
                statusText = '正常范围';
                statusClass = 'bg-success';
            } else if (hba1c < 6.5) {
                statusText = '糖尿病前期';
                statusClass = 'bg-warning';
            } else if (hba1c < 7.0) {
                statusText = '控制良好';
                statusClass = 'bg-info';
            } else if (hba1c < 8.0) {
                statusText = '控制一般';
                statusClass = 'bg-warning';
            } else {
                statusText = '控制较差';
                statusClass = 'bg-danger';
            }

            statusElement.innerHTML = `<small class="badge ${statusClass}">${statusText}</small>`;
        } else {
            document.getElementById('hba1c-value').textContent = '--';
            document.getElementById('hba1c-unit').textContent = '%';
            document.getElementById('hba1c-status').innerHTML = '<small class="badge bg-secondary">--</small>';
        }

        // 血糖变异系数
        if (data.cv_data && data.cv_data.cv_percent) {
            const cv = data.cv_data.cv_percent;

            document.getElementById('cv-value').textContent = cv;

            // 设置状态标签和颜色
            const statusElement = document.getElementById('cv-status');
            let statusText = '';
            let statusClass = '';

            if (cv <= 36) {
                statusText = '波动良好';
                statusClass = 'bg-success';
            } else if (cv <= 50) {
                statusText = '波动一般';
                statusClass = 'bg-warning';
            } else {
                statusText = '波动较大';
                statusClass = 'bg-danger';
            }

            statusElement.innerHTML = `<small class="badge ${statusClass}">${statusText}</small>`;
        } else {
            document.getElementById('cv-value').textContent = '--';
            document.getElementById('cv-status').innerHTML = '<small class="badge bg-secondary">--</small>';
        }
    }
    
    // 更新血糖图表
    function updateGlucoseChart(glucoseData, treatmentData = [], activityData = []) {
        const ctx = document.getElementById('glucoseChart').getContext('2d');
        
        if (glucoseChart) {
            glucoseChart.destroy();
        }
        
        const labels = glucoseData.map(item => item.time).reverse();
        const values = glucoseData.map(item => item.value_mmol).reverse();
        
        // 处理餐食数据 - 转换为图表数据点
        const mealDataPoints = [];
        console.log('餐食数据:', treatmentData);
        console.log('血糖时间标签:', labels);
        treatmentData.forEach(meal => {
            if (meal.carbs > 0) { // 只显示有碳水化合物的餐食记录
                const mealTime = meal.time;
                console.log(`餐食时间: ${mealTime}, 是否存在精确匹配: ${labels.includes(mealTime)}`);
                
                // 尝试精确匹配
                let mealIndex = labels.indexOf(mealTime);
                let glucoseValue = null;
                
                // 如果精确匹配失败，尝试找到最接近的时间点（前后5分钟内）
                if (mealIndex === -1) {
                    console.log(`精确匹配失败，尝试模糊匹配餐食时间: ${mealTime}`);
                    const mealDateTime = new Date(mealTime);
                    
                    for (let i = 0; i < labels.length; i++) {
                        const labelDateTime = new Date(labels[i]);
                        const timeDiff = Math.abs(labelDateTime - mealDateTime);
                        const timeDiffMinutes = timeDiff / (1000 * 60);
                        
                        if (timeDiffMinutes <= 5) { // 5分钟内认为匹配
                            mealIndex = i;
                            glucoseValue = values[i];
                            console.log(`找到模糊匹配: 索引${i}, 时间差${timeDiffMinutes.toFixed(1)}分钟`);
                            break;
                        }
                    }
                } else {
                    glucoseValue = values[mealIndex];
                }
                
                if (mealIndex !== -1 && glucoseValue !== null) {
                    // 将餐食图标放置在血糖曲线上方，错开显示
                    const mealIndexInArray = mealDataPoints.length;
                    const offsetValue = glucoseValue + (0.8 + (mealIndexInArray % 3) * 0.4); // 错开显示，避免重叠
                    const dataPoint = {
                        x: labels[mealIndex], // 使用血糖数据的时间点
                        y: offsetValue, // 调整后的Y坐标，在血糖曲线上方
                        originalY: glucoseValue, // 原始血糖值，用于显示
                        carbs: meal.carbs,
                        event_type: meal.event_type || '餐食',
                        original_time: mealTime // 原始餐食时间，用于调试
                    };
                    mealDataPoints.push(dataPoint);
                    console.log(`添加餐食数据点:`, dataPoint);
                }
            }
        });
        
        // 处理运动数据 - 转换为图表数据点
        const activityDataPoints = [];
        console.log('运动数据:', activityData);
        activityData.forEach(activity => {
            if (activity.duration > 0) { // 只显示有时长的运动记录
                const activityTime = activity.time;
                console.log(`运动时间: ${activityTime}, 是否存在精确匹配: ${labels.includes(activityTime)}`);
                
                // 尝试精确匹配
                let activityIndex = labels.indexOf(activityTime);
                let glucoseValue = null;
                
                // 如果精确匹配失败，尝试找到最接近的时间点（前后5分钟内）
                if (activityIndex === -1) {
                    console.log(`精确匹配失败，尝试模糊匹配运动时间: ${activityTime}`);
                    const activityDateTime = new Date(activityTime);
                    
                    for (let i = 0; i < labels.length; i++) {
                        const labelDateTime = new Date(labels[i]);
                        const timeDiff = Math.abs(labelDateTime - activityDateTime);
                        const timeDiffMinutes = timeDiff / (1000 * 60);
                        
                        if (timeDiffMinutes <= 5) { // 5分钟内认为匹配
                            activityIndex = i;
                            glucoseValue = values[i];
                            console.log(`找到模糊匹配: 索引${i}, 时间差${timeDiffMinutes.toFixed(1)}分钟`);
                            break;
                        }
                    }
                } else {
                    glucoseValue = values[activityIndex];
                }
                
                if (activityIndex !== -1 && glucoseValue !== null) {
                    // 将运动图标放置在血糖曲线下方，错开显示
                    const activityIndexInArray = activityDataPoints.length;
                    const offsetValue = Math.max(0.5, glucoseValue - (0.8 + (activityIndexInArray % 3) * 0.4)); // 错开显示，避免重叠，且不低于0.5
                    const dataPoint = {
                        x: labels[activityIndex], // 使用血糖数据的时间点
                        y: offsetValue, // 调整后的Y坐标，在血糖曲线下方
                        originalY: glucoseValue, // 原始血糖值，用于显示
                        duration: activity.duration,
                        event_type: activity.event_type || '运动',
                        notes: activity.notes || '', // 添加备注字段
                        original_time: activityTime // 原始运动时间，用于调试
                    };
                    activityDataPoints.push(dataPoint);
                    console.log(`添加运动数据点:`, dataPoint);
                }
            }
        });
        
        console.log('最终餐食数据点:', mealDataPoints);
        console.log('最终运动数据点:', activityDataPoints);
        
        console.log('开始创建图表，餐食数据点数量:', mealDataPoints.length);
        console.log('开始创建图表，运动数据点数量:', activityDataPoints.length);
        console.log('餐食数据点示例:', mealDataPoints.slice(0, 2));
        console.log('运动数据点示例:', activityDataPoints.slice(0, 2));
        
        // 创建自定义插件来绘制垂直虚线
        const verticalLinePlugin = {
            id: 'verticalLinePlugin',
            afterDraw: function(chart) {
                const ctx = chart.ctx;
                const xScale = chart.scales.x;
                const yScale = chart.scales.y;
                
                // 合并所有需要绘制虚线的数据点
                const allDataPoints = [
                    ...mealDataPoints.map(point => ({...point, type: 'meal', color: '#fd7e14'})),
                    ...activityDataPoints.map(point => ({...point, type: 'activity', color: '#20c997'}))
                ];
                
                allDataPoints.forEach(dataPoint => {
                    // 找到对应时间点的索引
                    const xIndex = labels.indexOf(dataPoint.x);
                    if (xIndex !== -1) {
                        const x = xScale.getPixelForValue(xIndex);
                        const y = yScale.getPixelForValue(dataPoint.y);
                        const bottomY = chart.scales.y.bottom; // 图表底部
                        
                        // 绘制垂直虚线
                        ctx.save();
                        ctx.strokeStyle = dataPoint.color;
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 5]); // 虚线样式
                        ctx.globalAlpha = 0.6;
                        
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x, bottomY);
                        ctx.stroke();
                        
                        ctx.restore();
                    }
                });
            }
        };
        
        glucoseChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '血糖值 (mmol/L)',
                    data: values,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.1,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }, {
                    label: '目标范围上限',
                    data: new Array(labels.length).fill(10.0),
                    borderColor: '#28a745',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }, {
                    label: '目标范围下限',
                    data: new Array(labels.length).fill(3.9),
                    borderColor: '#28a745',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }, {
                    label: '餐食记录',
                    data: mealDataPoints,
                    backgroundColor: '#fd7e14',
                    borderColor: '#fd7e14',
                    showLine: false,
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    pointStyle: 'triangle',
                    rotation: 0
                }, {
                    label: '运动记录',
                    data: activityDataPoints,
                    backgroundColor: '#20c997',
                    borderColor: '#20c997',
                    showLine: false,
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    pointStyle: 'rectRot',
                    rotation: 45
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: true,
                    mode: 'nearest'
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: Math.min(3.0, Math.min(...values) - 1),
                        max: Math.max(15.0, Math.max(...values) + 1),
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                size: window.innerWidth < 768 ? 10 : 12
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxTicksLimit: window.innerWidth < 768 ? 6 : 10,
                            font: {
                                size: window.innerWidth < 768 ? 10 : 12
                            },
                            maxRotation: window.innerWidth < 768 ? 45 : 0
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                plugins: {
                    // 注册自定义插件
                    ...[verticalLinePlugin],
                    legend: {
                        display: true,
                        position: window.innerWidth < 768 ? 'bottom' : 'top',
                        labels: {
                            font: {
                                size: window.innerWidth < 768 ? 10 : 12
                            },
                            usePointStyle: true,
                            padding: window.innerWidth < 768 ? 10 : 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: {
                            size: window.innerWidth < 768 ? 12 : 14
                        },
                        bodyFont: {
                            size: window.innerWidth < 768 ? 11 : 13
                        },
                        padding: window.innerWidth < 768 ? 8 : 12,
                        callbacks: {
                            title: function(tooltipItems) {
                                console.log('=== Title回调调用 ===');
                                console.log('tooltipItems:', tooltipItems);
                                
                                if (!tooltipItems || tooltipItems.length === 0) {
                                    console.log('tooltipItems为空');
                                    return '';
                                }
                                
                                const tooltipItem = tooltipItems[0];
                                console.log('tooltipItem:', tooltipItem);
                                
                                const datasetIndex = tooltipItem.datasetIndex;
                                const dataIndex = tooltipItem.dataIndex;
                                const dataset = tooltipItem.chart.data.datasets[datasetIndex];
                                const dataPoint = dataset.data[dataIndex];
                                
                                console.log('datasetIndex:', datasetIndex, 'dataIndex:', dataIndex);
                                console.log('dataPoint:', dataPoint);
                                
                                if (datasetIndex === 3 && dataPoint && dataPoint.originalY !== undefined) {
                                    console.log('返回餐食标题');
                                    return `🍽️ 餐食记录`;
                                } else if (datasetIndex === 4 && dataPoint && dataPoint.originalY !== undefined) {
                                    console.log('返回运动标题');
                                    return `🏃 运动记录`;
                                }
                                
                                console.log('返回默认标题:', dataset.label);
                                return dataset.label;
                            },
                            label: function(context) {
                                const datasetIndex = context.datasetIndex;
                                const dataIndex = context.dataIndex;
                                const dataset = context.chart.data.datasets[datasetIndex];
                                const dataPoint = dataset.data[dataIndex];
                                
                                if (datasetIndex === 3 && dataPoint && dataPoint.originalY !== undefined) {
                                    return [
                                        `碳水: ${dataPoint.carbs}g`,
                                        `类型: ${dataPoint.event_type}`,
                                        `血糖: ${dataPoint.originalY.toFixed(1)} mmol/L`
                                    ];
                                } else if (datasetIndex === 4 && dataPoint && dataPoint.originalY !== undefined) {
                                    console.log('=== 运动工具提示调试 ===');
                                    console.log('数据点:', dataPoint);
                                    
                                    const exerciseType = dataPoint.event_type || '运动';
                                    const exerciseNotes = dataPoint.notes || '';
                                    
                                    console.log('运动类型:', exerciseType);
                                    console.log('运动备注:', exerciseNotes);
                                    
                                    // 构建显示内容，与运动记录表格保持一致
                                    const durationDisplay = dataPoint.duration > 0 ? `${dataPoint.duration}分钟` : '';
                                    const typeDisplay = exerciseType;
                                    
                                    // 如果event_type中包含" - "，则前面部分为类型，后面部分为备注
                                    let notesDisplay = exerciseNotes;
                                    if (!notesDisplay && exerciseType.includes(' - ')) {
                                        const parts = exerciseType.split(' - ');
                                        if (parts.length > 1) {
                                            notesDisplay = parts.slice(1).join(' - ');
                                        }
                                    }
                                    
                                    console.log('最终备注显示:', notesDisplay);
                                    
                                    // 先尝试简单的字符串返回
                                    let simpleResult = `时长: ${durationDisplay} | 类型: ${typeDisplay}`;
                                    if (notesDisplay && notesDisplay.trim() !== '') {
                                        simpleResult += ` | 备注: ${notesDisplay}`;
                                    }
                                    simpleResult += ` | 血糖: ${dataPoint.originalY.toFixed(1)} mmol/L`;
                                    
                                    console.log('简单结果字符串:', simpleResult);
                                    
                                    // 再尝试数组格式
                                    const result = [`时长: ${durationDisplay}`, `类型: ${typeDisplay}`];
                                    if (notesDisplay && notesDisplay.trim() !== '') {
                                        result.push(`备注: ${notesDisplay}`);
                                        console.log('添加备注行:', notesDisplay);
                                    } else {
                                        console.log('备注为空，不添加');
                                    }
                                    
                                    console.log('数组结果:', result);
                                    
                                    // 临时返回简单字符串进行测试
                                    return simpleResult;
                                }
                                
                                const timeLabel = context.label;
                                return `${dataset.label}: ${context.parsed.y.toFixed(1)} mmol/L\n时间: ${timeLabel}`;
                            },
                            afterLabel: function(context) {
                                const datasetIndex = context.datasetIndex;
                                const dataIndex = context.dataIndex;
                                const dataset = context.chart.data.datasets[datasetIndex];
                                const dataPoint = dataset.data[dataIndex];
                                
                                if (datasetIndex === 3 && dataPoint && dataPoint.originalY !== undefined) {
                                    return `时间: ${dataPoint.original_time}`;
                                } else if (datasetIndex === 4 && dataPoint && dataPoint.originalY !== undefined) {
                                    return `时间: ${dataPoint.original_time}`;
                                }
                                
                                return '';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 获取AI分析
    function getAnalysis() {
        const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
        modal.show();
        
        document.getElementById('analysis-content').innerHTML = `
            <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i> 分析中，请稍候...
            </div>
        `;
        
        fetch(`/api/analysis?days=${currentDays}`)
            .then(response => response.json())
            .then(data => {
                if (data.analysis) {
                    document.getElementById('analysis-content').innerHTML = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> 分析结果</h6>
                            <pre style="white-space: pre-wrap; font-family: inherit;">${data.analysis}</pre>
                        </div>
                    `;
                } else {
                    document.getElementById('analysis-content').innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle"></i> 分析失败</h6>
                            <p>${data.error || '未知错误'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('analysis-content').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> 分析失败</h6>
                        <p>网络错误: ${error.message}</p>
                    </div>
                `;
            });
    }
    
    // 复制分析结果
    function copyAnalysis() {
        const content = document.querySelector('#analysis-content pre');
        if (content) {
            navigator.clipboard.writeText(content.textContent).then(() => {
                showNotification('分析结果已复制到剪贴板', 'success');
            });
        }
    }
    

    // 打开AI咨询模态框
    function openAIConsult() {
        const modal = new bootstrap.Modal(document.getElementById('consultModal'));
        modal.show();

        // 清空之前的内容
        document.getElementById('consultQuestion').value = '';
        document.getElementById('consult-response').style.display = 'none';
        document.getElementById('copyConsultBtn').style.display = 'none';
        document.getElementById('consultSubmitBtn').disabled = false;
    }

    // 提交AI咨询
    function submitConsult() {
        const question = document.getElementById('consultQuestion').value.trim();
        const includeData = document.getElementById('includeGlucoseData').checked;
        const submitBtn = document.getElementById('consultSubmitBtn');
        const originalText = submitBtn.innerHTML;

        if (!question) {
            showNotification('请输入您的问题', 'warning');
            return;
        }

        // 显示加载状态
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 咨询中...';
        submitBtn.disabled = true;

        // 显示回复区域
        document.getElementById('consult-response').style.display = 'block';
        document.getElementById('consult-content').innerHTML = `
            <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i> AI正在思考中，请稍候...
            </div>
        `;

        // 构建请求数据
        const requestData = {
            question: question,
            include_data: includeData,
            days: currentDays
        };

        fetch('/api/ai-consult', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.response) {
                document.getElementById('consult-content').innerHTML = `
                    <div class="ai-response">
                        ${data.response.replace(/\n/g, '<br>')}
                    </div>
                `;
                document.getElementById('copyConsultBtn').style.display = 'inline-block';
                showNotification('AI咨询完成', 'success');
            } else {
                document.getElementById('consult-content').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> 咨询失败</h6>
                        <p>${data.error || '未知错误'}</p>
                    </div>
                `;
                showNotification('AI咨询失败: ' + (data.error || '未知错误'), 'danger');
            }
        })
        .catch(error => {
            document.getElementById('consult-content').innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> 咨询失败</h6>
                    <p>网络错误: ${error.message}</p>
                </div>
            `;
            showNotification('咨询失败: ' + error.message, 'danger');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }

    // 复制AI咨询回复
    function copyConsultResponse() {
        const content = document.getElementById('consult-content').innerText;
        navigator.clipboard.writeText(content).then(() => {
            showNotification('回复已复制到剪贴板', 'success');
        }).catch(() => {
            showNotification('复制失败，请手动选择复制', 'warning');
        });
    }

    // 生成报表
    function generateReport() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        let reportUrl = '/report';
        
        if (startDate && endDate) {
            // 使用自定义日期范围
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('开始日期不能晚于结束日期', 'warning');
                return;
            }
            reportUrl += `?start_date=${startDate}&end_date=${endDate}`;
        } else {
            // 使用当前天数
            const today = new Date().toISOString().split('T')[0];
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - (currentDays - 1));
            const startDateStr = startDate.toISOString().split('T')[0];
            reportUrl += `?start_date=${startDateStr}&end_date=${today}`;
        }
        
        // 在新窗口打开报表页面
        window.open(reportUrl, '_blank');
    }
    
    // 打开消息收件箱
    function openMessageInbox() {
        window.open('/messages', '_blank');
    }
    
    // 更新未读消息数量指示器
    function updateUnreadCountIndicator() {
        fetch('/api/messages/unread-count')
            .then(response => response.json())
            .then(data => {
                const messageBtn = document.querySelector('button[onclick="openMessageInbox()"]');
                if (messageBtn && data.unread_count > 0) {
                    // 移除可能已存在的红点
                    const existingBadge = messageBtn.querySelector('.unread-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    // 添加新的红点
                    const badge = document.createElement('span');
                    badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger unread-badge';
                    badge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
                    messageBtn.appendChild(badge);
                    messageBtn.classList.add('position-relative');
                }
            })
            .catch(error => {
                console.error('获取未读消息数量失败:', error);
            });
    }
</script>
{% endblock %}
