{% extends "base.html" %}

{% block title %}è¡€ç³–æ•°æ® - Nightscout è¡€ç³–ç›‘æ§{% endblock %}

{% block content %}
<div class="row">
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt"></i> æ§åˆ¶é¢æ¿
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-12 col-xl-7 mb-3 mb-xl-0">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(1)">ä»Šæ—¥</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(3)">3æ—¥</button>
                            <button type="button" class="btn btn-primary active btn-sm" onclick="loadData(7)">7æ—¥</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(15)">15æ—¥</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(30)">30æ—¥</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(60)">60æ—¥</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadData(90)">90æ—¥</button>
                            <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="collapse" data-bs-target="#customDateCollapse">è‡ªå®šä¹‰</button>
                        </div>
                    </div>
                    <div class="col-12 col-xl-5">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button class="btn btn-primary btn-sm" onclick="generateReport()">
                                <i class="fas fa-file-alt"></i> <span class="d-none d-sm-inline">ç”ŸæˆæŠ¥è¡¨</span>
                            </button>
                            <button class="btn btn-success btn-sm" onclick="getAnalysis()">
                                <i class="fas fa-brain"></i> <span class="d-none d-sm-inline">AIåˆ†æ</span>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="openAIConsult()">
                                <i class="fas fa-comments"></i> <span class="d-none d-sm-inline">AIå’¨è¯¢</span>
                            </button>
                            <button class="btn btn-info btn-sm" onclick="openMessageInbox()">
                                <i class="fas fa-envelope"></i> <span class="d-none d-sm-inline">æ¶ˆæ¯è®°å½•</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹© -->
    <div class="col-12 mb-4">
        <div class="collapse" id="customDateCollapse">
            <div class="card card-body">
                <div class="row align-items-end">
                    <div class="col-md-5 mb-2 mb-md-0">
                        <label for="startDate" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-5 mb-2 mb-md-0">
                        <label for="endDate" class="form-label">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="endDate" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary btn-sm w-100" onclick="loadCustomDateRange()">æŸ¥è¯¢</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="col-12 mb-4">
        <div class="row" id="stats-cards">
            <div class="col-6 col-xl-2 col-lg-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-primary mb-2">å¹³å‡è¡€ç³–</h6>
                        <h4 id="avg-glucose" class="mb-1">--</h4>
                        <small class="text-muted">mmol/L</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-success mb-2">ç›®æ ‡èŒƒå›´å†…</h6>
                        <h4 id="in-range" class="mb-1">--</h4>
                        <small class="text-muted">%</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-warning mb-2">æœ€é«˜è¡€ç³–</h6>
                        <h4 id="max-glucose" class="mb-1">--</h4>
                        <small class="text-muted">mmol/L</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-danger mb-2">æœ€ä½è¡€ç³–</h6>
                        <h4 id="min-glucose" class="mb-1">--</h4>
                        <small class="text-muted">mmol/L</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-6 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-info mb-2">ç³–åŒ–è¡€çº¢è›‹ç™½</h6>
                        <h4 id="hba1c-value" class="mb-1">--</h4>
                        <small id="hba1c-unit" class="text-muted">%</small>
                        <div id="hba1c-status" class="mt-1">
                            <small class="badge bg-secondary">--</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-2 col-lg-6 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body py-3">
                        <h6 class="card-title text-purple mb-2">è¡€ç³–å˜å¼‚ç³»æ•°</h6>
                        <h4 id="cv-value" class="mb-1">--</h4>
                        <small class="text-muted">%</small>
                        <div id="cv-status" class="mt-1">
                            <small class="badge bg-secondary">--</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¡€ç³–å›¾è¡¨ -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line"></i> è¡€ç³–è¶‹åŠ¿å›¾
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="glucoseChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- è¡€ç³–æ•°æ®è¡¨æ ¼ -->
    <div class="col-12 col-xl-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table"></i> è¡€ç³–æ•°æ®
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="sticky-header">
                            <tr>
                                <th class="d-none d-sm-table-cell">æ—¶é—´</th>
                                <th class="d-sm-none">æ—¶é—´/è¡€ç³–</th>
                                <th class="d-none d-sm-table-cell">è¡€ç³–å€¼ (mmol/L)</th>
                                <th class="d-none d-md-table-cell">è¡€ç³–å€¼ (mg/dL)</th>
                                <th class="d-none d-sm-table-cell">è¶‹åŠ¿</th>
                            </tr>
                        </thead>
                        <tbody id="glucose-table-body">
                            <tr>
                                <td colspan="4" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æ²»ç–—æ•°æ®è¡¨æ ¼ -->
    <div class="col-12 col-xl-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-utensils"></i> é¤é£Ÿè®°å½•
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="sticky-header">
                            <tr>
                                <th class="d-none d-sm-table-cell">æ—¶é—´</th>
                                <th class="d-sm-none">æ—¶é—´/è¥å…»</th>
                                <th class="d-none d-sm-table-cell">è¥å…»æˆåˆ†</th>
                                <th class="d-none d-md-table-cell">ç±»å‹/å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody id="treatment-table-body">
                            <tr>
                                <td colspan="3" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿åŠ¨æ•°æ®è¡¨æ ¼ -->
    <div class="col-12 col-xl-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-running"></i> è¿åŠ¨è®°å½•
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="sticky-header">
                            <tr>
                                <th class="d-none d-sm-table-cell">æ—¶é—´</th>
                                <th class="d-sm-none">æ—¶é—´/è¿åŠ¨</th>
                                <th class="d-none d-sm-table-cell">è¿åŠ¨ç±»å‹</th>
                                <th class="d-none d-md-table-cell">æ—¶é•¿/å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table-body">
                            <tr>
                                <td colspan="3" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æŒ‡å°–è¡€ç³–æ•°æ®è¡¨æ ¼ -->
    <div class="col-12 col-xl-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tint"></i> æŒ‡å°–è¡€ç³–è®°å½•
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="sticky-header">
                            <tr>
                                <th class="d-none d-sm-table-cell">æ—¶é—´</th>
                                <th class="d-sm-none">æ—¶é—´/è¡€ç³–</th>
                                <th class="d-none d-sm-table-cell">è¡€ç³–å€¼</th>
                                <th class="d-none d-md-table-cell">åŒæ—¶é—´CGMè¡€ç³–å€¼</th>
                            </tr>
                        </thead>
                        <tbody id="meter-table-body">
                            <tr>
                                <td colspan="3" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AIåˆ†ææ¨¡æ€æ¡† -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-brain"></i> AIè¡€ç³–åˆ†ææŠ¥å‘Š
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysis-content">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> åˆ†æä¸­ï¼Œè¯·ç¨å€™...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="copyAnalysis()">
                    <i class="fas fa-copy"></i> å¤åˆ¶åˆ†æ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AIå’¨è¯¢æ¨¡æ€æ¡† -->
<div class="modal fade" id="consultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-comments"></i> AIè¡€ç³–å’¨è¯¢
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="consultQuestion" class="form-label">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼š</label>
                    <textarea class="form-control" id="consultQuestion" rows="3"
                              placeholder="ä¾‹å¦‚ï¼šæˆ‘ä»Šå¤©çš„è¡€ç³–æ³¢åŠ¨å¤§å—ï¼Ÿåº”è¯¥æ³¨æ„ä»€ä¹ˆï¼Ÿ"></textarea>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeGlucoseData" checked>
                        <label class="form-check-label" for="includeGlucoseData">
                            é™„å¸¦è¡€ç³–ä¿¡æ¯ä½œä¸ºä¸Šä¸‹æ–‡
                        </label>
                    </div>
                </div>
                <div id="consult-response" style="display: none;">
                    <hr>
                    <h6><i class="fas fa-robot"></i> AIå›å¤ï¼š</h6>
                    <div id="consult-content" class="border rounded p-3 bg-light">
                        <!-- AIå›å¤å†…å®¹ -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="submitConsult()" id="consultSubmitBtn">
                    <i class="fas fa-paper-plane"></i> æäº¤å’¨è¯¢
                </button>
                <button type="button" class="btn btn-success" onclick="copyConsultResponse()" id="copyConsultBtn" style="display: none;">
                    <i class="fas fa-copy"></i> å¤åˆ¶å›å¤
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentDays = 7;
    let glucoseChart = null;
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // è®¾ç½®è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨çš„é»˜è®¤å€¼
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
        document.getElementById('startDate').value = sevenDaysAgo.toISOString().split('T')[0];

        // å…ˆåŒæ­¥æ•°æ®ï¼Œç„¶ååŠ è½½æ˜¾ç¤º
        syncDataAndLoad();
        
        // æ›´æ–°æœªè¯»æ¶ˆæ¯æ•°é‡
        updateUnreadCountIndicator();
    });

    // åŒæ­¥æ•°æ®å¹¶åŠ è½½ï¼ˆé¡µé¢åŠ è½½æ—¶ä½¿ç”¨ï¼‰
    function syncDataAndLoad() {
        // é™é»˜åŒæ­¥ï¼Œä¸æ˜¾ç¤ºæˆåŠŸæç¤º
        fetch('/api/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({days: 7})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // åªåœ¨æ§åˆ¶å°è®°å½•æˆåŠŸä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
                console.log(`åŒæ­¥æˆåŠŸï¼è·å–åˆ° ${data.glucose_count} æ¡è¡€ç³–æ•°æ®å’Œ ${data.treatment_count} æ¡æ²»ç–—æ•°æ®`);
                // åŒæ­¥æˆåŠŸååŠ è½½æ•°æ®
                loadData(7);
            } else {
                showNotification('åŒæ­¥å¤±è´¥: ' + data.error, 'warning');
                // å³ä½¿åŒæ­¥å¤±è´¥ä¹Ÿå°è¯•åŠ è½½æœ¬åœ°æ•°æ®
                loadData(7);
            }
        })
        .catch(error => {
            console.error('åŒæ­¥å¤±è´¥:', error);
            showNotification('åŒæ­¥å¤±è´¥: ' + error.message, 'warning');
            // åŒæ­¥å¤±è´¥ä¹ŸåŠ è½½æœ¬åœ°æ•°æ®
            loadData(7);
        });
    }
    
    // æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
    function updateActiveButton(targetButton) {
        document.querySelectorAll('.btn-group .btn, [data-bs-target="#customDateCollapse"]').forEach(btn => {
            btn.classList.remove('active', 'btn-primary');
            if (!btn.classList.contains('btn-outline-info')) {
                 btn.classList.add('btn-outline-primary');
            }
        });
        
        if (targetButton) {
            targetButton.classList.remove('btn-outline-primary', 'btn-outline-info');
            targetButton.classList.add('btn-primary', 'active');
        }
    }

    // åŠ è½½æ•°æ®ï¼ˆæŒ‰å¤©æ•°ï¼‰
    function loadData(days) {
        currentDays = days;
        const url = `?days=${days}`;
        fetchAndLoadData(url);
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const buttons = document.querySelectorAll('.btn-group .btn');
        const btnDays = [1, 3, 7, 15, 30, 60, 90];
        const buttonIndex = btnDays.indexOf(days);
        if (buttonIndex !== -1) {
            updateActiveButton(buttons[buttonIndex]);
        }
    }

    // åŠ è½½æ•°æ®ï¼ˆæŒ‰è‡ªå®šä¹‰æ—¥æœŸï¼‰
    function loadCustomDateRange() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
            showNotification('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ', 'warning');
            return;
        }
        if (new Date(startDate) > new Date(endDate)) {
            showNotification('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ', 'warning');
            return;
        }

        const url = `?start_date=${startDate}&end_date=${endDate}`;
        fetchAndLoadData(url);
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const customButton = document.querySelector('[data-bs-target="#customDateCollapse"]');
        updateActiveButton(customButton);
    }

    // æ ¸å¿ƒæ•°æ®è·å–å’ŒåŠ è½½å‡½æ•°
    function fetchAndLoadData(urlParams) {
        // åŠ è½½è¡€ç³–æ•°æ®
        fetch(`/api/glucose-data${urlParams}`)
            .then(response => response.json())
            .then(glucoseData => {
                updateGlucoseTable(glucoseData);
                
                // å¹¶è¡ŒåŠ è½½é¤é£Ÿå’Œè¿åŠ¨æ•°æ®ï¼Œç„¶åæ›´æ–°å›¾è¡¨
                Promise.all([
                    fetch(`/api/treatment-data${urlParams}`).then(response => response.json()),
                    fetch(`/api/activity-data${urlParams}`).then(response => response.json())
                ]).then(([treatmentData, activityData]) => {
                    updateGlucoseChart(glucoseData, treatmentData, activityData);
                }).catch(error => {
                    console.error('åŠ è½½é¤é£Ÿæˆ–è¿åŠ¨æ•°æ®å¤±è´¥:', error);
                    // å³ä½¿é¤é£Ÿ/è¿åŠ¨æ•°æ®åŠ è½½å¤±è´¥ï¼Œä¹Ÿåªæ˜¾ç¤ºè¡€ç³–æ•°æ®
                    updateGlucoseChart(glucoseData, [], []);
                });
            })
            .catch(error => {
                console.error('åŠ è½½è¡€ç³–æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½è¡€ç³–æ•°æ®å¤±è´¥', 'danger');
            });

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        fetch(`/api/statistics${urlParams}`)
            .then(response => response.json())
            .then(data => {
                updateStats(data);
            })
            .catch(error => {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                updateStats({});
            });
        
        // åŠ è½½æ²»ç–—æ•°æ®
        fetch(`/api/treatment-data${urlParams}`)
            .then(response => response.json())
            .then(data => {
                updateTreatmentTable(data);
            })
            .catch(error => {
                console.error('åŠ è½½æ²»ç–—æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½æ²»ç–—æ•°æ®å¤±è´¥', 'danger');
            });

        // åŠ è½½è¿åŠ¨æ•°æ®
        fetch(`/api/activity-data${urlParams}`)
            .then(response => response.json())
            .then(data => {
                updateActivityTable(data);
            })
            .catch(error => {
                console.error('åŠ è½½è¿åŠ¨æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½è¿åŠ¨æ•°æ®å¤±è´¥', 'danger');
            });

        // åŠ è½½æŒ‡å°–è¡€ç³–æ•°æ®
        fetch(`/api/meter-data${urlParams}`)
            .then(response => response.json())
            .then(data => {
                updateMeterTable(data);
            })
            .catch(error => {
                console.error('åŠ è½½æŒ‡å°–è¡€ç³–æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½æŒ‡å°–è¡€ç³–æ•°æ®å¤±è´¥', 'danger');
            });
    }
    
    // æ›´æ–°è¡€ç³–è¡¨æ ¼
    function updateGlucoseTable(data) {
        const tbody = document.getElementById('glucose-table-body');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(item => {
            // ç§»åŠ¨ç«¯åˆå¹¶æ˜¾ç¤º
            const mobileContent = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${item.time.split(' ')[1]}</div>
                        <small class="text-muted">${item.time.split(' ')[0]}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold ${getGlucoseColor(item.value_mmol)}">${formatGlucoseValue(item.value_mmol)} mmol/L</div>
                        <small class="text-muted">${item.value_mgdl} mg/dL ${formatDirection(item.direction)}</small>
                    </div>
                </div>
            `;

            return `
                <tr>
                    <td class="d-none d-sm-table-cell">${item.time}</td>
                    <td class="d-sm-none">${mobileContent}</td>
                    <td class="d-none d-sm-table-cell ${getGlucoseColor(item.value_mmol)}">${formatGlucoseValue(item.value_mmol)}</td>
                    <td class="d-none d-md-table-cell">${item.value_mgdl}</td>
                    <td class="d-none d-sm-table-cell">${formatDirection(item.direction)}</td>
                </tr>
            `;
        }).join('');
    }

    // è·å–è¡€ç³–å€¼é¢œè‰²
    function getGlucoseColor(value) {
        if (value < 3.9) return 'text-danger';
        if (value > 10.0) return 'text-warning';
        return 'text-success';
    }
    
    // æ›´æ–°æ²»ç–—è¡¨æ ¼
    function updateTreatmentTable(data) {
        const tbody = document.getElementById('treatment-table-body');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        // è¿‡æ»¤æœ‰è¥å…»æˆåˆ†çš„æ•°æ®ï¼ˆç¢³æ°´ã€è›‹ç™½è´¨æˆ–è„‚è‚ªä»»ä¸€å¤§äº0ï¼‰
        const filteredData = data.filter(item =>
            (item.carbs && item.carbs > 0) ||
            (item.protein && item.protein > 0) ||
            (item.fat && item.fat > 0) ||
            item.event_type === 'Carb Correction' ||
            item.event_type === 'Meal Bolus'
        );

        tbody.innerHTML = filteredData.map(item => {
            // æ„å»ºè¥å…»æˆåˆ†æ˜¾ç¤º
            const nutritionParts = [];
            if (item.carbs && item.carbs > 0) {
                nutritionParts.push(`<span class="badge bg-primary me-1">${item.carbs}gç¢³æ°´</span>`);
            }
            if (item.protein && item.protein > 0) {
                nutritionParts.push(`<span class="badge bg-success me-1">${item.protein}gè›‹ç™½è´¨</span>`);
            }
            if (item.fat && item.fat > 0) {
                nutritionParts.push(`<span class="badge bg-warning me-1">${item.fat}gè„‚è‚ª</span>`);
            }

            // å¦‚æœæ²¡æœ‰è¥å…»æˆåˆ†ä½†æ˜¯ç›¸å…³äº‹ä»¶ç±»å‹ï¼Œæ˜¾ç¤ºäº‹ä»¶ç±»å‹
            const nutritionDisplay = nutritionParts.length > 0
                ? nutritionParts.join('')
                : `<span class="text-muted">${item.event_type || 'æ— è¥å…»æ•°æ®'}</span>`;

            // æ„å»ºç±»å‹/å¤‡æ³¨æ˜¾ç¤º
            const typeAndNotes = [];
            if (item.event_type && item.event_type !== 'Meal Bolus') {
                typeAndNotes.push(item.event_type);
            }
            if (item.notes) {
                typeAndNotes.push(item.notes);
            }
            const typeDisplay = typeAndNotes.length > 0 ? typeAndNotes.join(' - ') : '-';

            // ç§»åŠ¨ç«¯åˆå¹¶æ˜¾ç¤º
            const mobileContent = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold">${item.time.split(' ')[1]}</div>
                        <small class="text-muted">${item.time.split(' ')[0]}</small>
                    </div>
                    <div class="text-end">
                        <div class="mb-1">${nutritionDisplay}</div>
                        <small class="text-muted">${typeDisplay}</small>
                    </div>
                </div>
            `;

            return `
                <tr>
                    <td class="d-none d-sm-table-cell">${item.time}</td>
                    <td class="d-sm-none">${mobileContent}</td>
                    <td class="d-none d-sm-table-cell">${nutritionDisplay}</td>
                    <td class="d-none d-md-table-cell">${typeDisplay}</td>
                </tr>
            `;
        }).join('');
    }

    // æ›´æ–°è¿åŠ¨è¡¨æ ¼
    function updateActivityTable(data) {
        const tbody = document.getElementById('activity-table-body');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(item => {
            // æ„å»ºæ—¶é•¿æ˜¾ç¤º
            const durationDisplay = item.duration > 0 ? `${item.duration}åˆ†é’Ÿ` : '-';
            
            // æ„å»ºç±»å‹/å¤‡æ³¨æ˜¾ç¤º
            const typeAndNotes = [];
            if (item.event_type) {
                typeAndNotes.push(item.event_type);
            }
            if (item.notes) {
                typeAndNotes.push(item.notes);
            }
            const typeDisplay = typeAndNotes.length > 0 ? typeAndNotes.join(' - ') : '-';

            // ç§»åŠ¨ç«¯åˆå¹¶æ˜¾ç¤º
            const mobileContent = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold">${item.time.split(' ')[1]}</div>
                        <small class="text-muted">${item.time.split(' ')[0]}</small>
                    </div>
                    <div class="text-end">
                        <div class="mb-1">${item.event_type || 'è¿åŠ¨'}</div>
                        <small class="text-muted">${durationDisplay} ${typeDisplay !== '-' ? typeDisplay : ''}</small>
                    </div>
                </div>
            `;

            return `
                <tr>
                    <td class="d-none d-sm-table-cell">${item.time}</td>
                    <td class="d-sm-none">${mobileContent}</td>
                    <td class="d-none d-sm-table-cell">${item.event_type || 'è¿åŠ¨'}</td>
                    <td class="d-none d-md-table-cell">${durationDisplay} ${typeDisplay !== '-' ? `<br><small class="text-muted">${typeDisplay}</small>` : ''}</td>
                </tr>
            `;
        }).join('');
    }

    // æ›´æ–°æŒ‡å°–è¡€ç³–è¡¨æ ¼
    function updateMeterTable(data) {
        const tbody = document.getElementById('meter-table-body');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(item => {
            // è·å–è¡€ç³–å€¼é¢œè‰²
            const glucoseColor = getGlucoseColor(item.value_mmol);
            const cgmGlucoseColor = item.cgm_value_mmol ? getGlucoseColor(item.cgm_value_mmol) : 'text-muted';
            const cgmValueDisplay = item.cgm_value_mmol ? formatGlucoseValue(item.cgm_value_mmol) : 'N/A';

            // ç§»åŠ¨ç«¯åˆå¹¶æ˜¾ç¤º
            const mobileContent = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold">${item.time.split(' ')[1]}</div>
                        <small class="text-muted">${item.time.split(' ')[0]}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold ${glucoseColor}">æŒ‡å°–: ${formatGlucoseValue(item.value_mmol)} mmol/L</div>
                        <small class="${cgmGlucoseColor}">CGM: ${cgmValueDisplay} mmol/L</small>
                    </div>
                </div>
            `;

            return `
                <tr>
                    <td class="d-none d-sm-table-cell">${item.time}</td>
                    <td class="d-sm-none">${mobileContent}</td>
                    <td class="d-none d-sm-table-cell ${glucoseColor}">${formatGlucoseValue(item.value_mmol)}</td>
                    <td class="d-none d-md-table-cell ${cgmGlucoseColor}">${cgmValueDisplay}</td>
                </tr>
            `;
        }).join('');
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(data) {
        // åŸºç¡€ç»Ÿè®¡æ•°æ®
        document.getElementById('avg-glucose').textContent = data.avg_glucose || '--';
        document.getElementById('in-range').textContent = data.in_range_percentage || '--';
        document.getElementById('max-glucose').textContent = data.max_glucose || '--';
        document.getElementById('min-glucose').textContent = data.min_glucose || '--';

        // ç³–åŒ–è¡€çº¢è›‹ç™½
        if (data.hba1c_data && data.hba1c_data.hba1c_adag_percent) {
            const hba1c = data.hba1c_data.hba1c_adag_percent;
            const hba1cMmol = data.hba1c_data.hba1c_adag_mmol;

            document.getElementById('hba1c-value').textContent = hba1c;
            document.getElementById('hba1c-unit').textContent = `% (${hba1cMmol} mmol/mol)`;

            // è®¾ç½®çŠ¶æ€æ ‡ç­¾å’Œé¢œè‰²
            const statusElement = document.getElementById('hba1c-status');
            let statusText = '';
            let statusClass = '';

            if (hba1c < 5.7) {
                statusText = 'æ­£å¸¸èŒƒå›´';
                statusClass = 'bg-success';
            } else if (hba1c < 6.5) {
                statusText = 'ç³–å°¿ç—…å‰æœŸ';
                statusClass = 'bg-warning';
            } else if (hba1c < 7.0) {
                statusText = 'æ§åˆ¶è‰¯å¥½';
                statusClass = 'bg-info';
            } else if (hba1c < 8.0) {
                statusText = 'æ§åˆ¶ä¸€èˆ¬';
                statusClass = 'bg-warning';
            } else {
                statusText = 'æ§åˆ¶è¾ƒå·®';
                statusClass = 'bg-danger';
            }

            statusElement.innerHTML = `<small class="badge ${statusClass}">${statusText}</small>`;
        } else {
            document.getElementById('hba1c-value').textContent = '--';
            document.getElementById('hba1c-unit').textContent = '%';
            document.getElementById('hba1c-status').innerHTML = '<small class="badge bg-secondary">--</small>';
        }

        // è¡€ç³–å˜å¼‚ç³»æ•°
        if (data.cv_data && data.cv_data.cv_percent) {
            const cv = data.cv_data.cv_percent;

            document.getElementById('cv-value').textContent = cv;

            // è®¾ç½®çŠ¶æ€æ ‡ç­¾å’Œé¢œè‰²
            const statusElement = document.getElementById('cv-status');
            let statusText = '';
            let statusClass = '';

            if (cv <= 36) {
                statusText = 'æ³¢åŠ¨è‰¯å¥½';
                statusClass = 'bg-success';
            } else if (cv <= 50) {
                statusText = 'æ³¢åŠ¨ä¸€èˆ¬';
                statusClass = 'bg-warning';
            } else {
                statusText = 'æ³¢åŠ¨è¾ƒå¤§';
                statusClass = 'bg-danger';
            }

            statusElement.innerHTML = `<small class="badge ${statusClass}">${statusText}</small>`;
        } else {
            document.getElementById('cv-value').textContent = '--';
            document.getElementById('cv-status').innerHTML = '<small class="badge bg-secondary">--</small>';
        }
    }
    
    // æ›´æ–°è¡€ç³–å›¾è¡¨
    function updateGlucoseChart(glucoseData, treatmentData = [], activityData = []) {
        const ctx = document.getElementById('glucoseChart').getContext('2d');
        
        if (glucoseChart) {
            glucoseChart.destroy();
        }
        
        const labels = glucoseData.map(item => item.time).reverse();
        const values = glucoseData.map(item => item.value_mmol).reverse();
        
        // å¤„ç†é¤é£Ÿæ•°æ® - è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®ç‚¹
        const mealDataPoints = [];
        console.log('é¤é£Ÿæ•°æ®:', treatmentData);
        console.log('è¡€ç³–æ—¶é—´æ ‡ç­¾:', labels);
        treatmentData.forEach(meal => {
            if (meal.carbs > 0) { // åªæ˜¾ç¤ºæœ‰ç¢³æ°´åŒ–åˆç‰©çš„é¤é£Ÿè®°å½•
                const mealTime = meal.time;
                console.log(`é¤é£Ÿæ—¶é—´: ${mealTime}, æ˜¯å¦å­˜åœ¨ç²¾ç¡®åŒ¹é…: ${labels.includes(mealTime)}`);
                
                // å°è¯•ç²¾ç¡®åŒ¹é…
                let mealIndex = labels.indexOf(mealTime);
                let glucoseValue = null;
                
                // å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ‰¾åˆ°æœ€æ¥è¿‘çš„æ—¶é—´ç‚¹ï¼ˆå‰å5åˆ†é’Ÿå†…ï¼‰
                if (mealIndex === -1) {
                    console.log(`ç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…é¤é£Ÿæ—¶é—´: ${mealTime}`);
                    const mealDateTime = new Date(mealTime);
                    
                    for (let i = 0; i < labels.length; i++) {
                        const labelDateTime = new Date(labels[i]);
                        const timeDiff = Math.abs(labelDateTime - mealDateTime);
                        const timeDiffMinutes = timeDiff / (1000 * 60);
                        
                        if (timeDiffMinutes <= 5) { // 5åˆ†é’Ÿå†…è®¤ä¸ºåŒ¹é…
                            mealIndex = i;
                            glucoseValue = values[i];
                            console.log(`æ‰¾åˆ°æ¨¡ç³ŠåŒ¹é…: ç´¢å¼•${i}, æ—¶é—´å·®${timeDiffMinutes.toFixed(1)}åˆ†é’Ÿ`);
                            break;
                        }
                    }
                } else {
                    glucoseValue = values[mealIndex];
                }
                
                if (mealIndex !== -1 && glucoseValue !== null) {
                    // å°†é¤é£Ÿå›¾æ ‡æ”¾ç½®åœ¨è¡€ç³–æ›²çº¿ä¸Šæ–¹ï¼Œé”™å¼€æ˜¾ç¤º
                    const mealIndexInArray = mealDataPoints.length;
                    const offsetValue = glucoseValue + (0.8 + (mealIndexInArray % 3) * 0.4); // é”™å¼€æ˜¾ç¤ºï¼Œé¿å…é‡å 
                    const dataPoint = {
                        x: labels[mealIndex], // ä½¿ç”¨è¡€ç³–æ•°æ®çš„æ—¶é—´ç‚¹
                        y: offsetValue, // è°ƒæ•´åçš„Yåæ ‡ï¼Œåœ¨è¡€ç³–æ›²çº¿ä¸Šæ–¹
                        originalY: glucoseValue, // åŸå§‹è¡€ç³–å€¼ï¼Œç”¨äºæ˜¾ç¤º
                        carbs: meal.carbs,
                        event_type: meal.event_type || 'é¤é£Ÿ',
                        original_time: mealTime // åŸå§‹é¤é£Ÿæ—¶é—´ï¼Œç”¨äºè°ƒè¯•
                    };
                    mealDataPoints.push(dataPoint);
                    console.log(`æ·»åŠ é¤é£Ÿæ•°æ®ç‚¹:`, dataPoint);
                }
            }
        });
        
        // å¤„ç†è¿åŠ¨æ•°æ® - è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®ç‚¹
        const activityDataPoints = [];
        console.log('è¿åŠ¨æ•°æ®:', activityData);
        activityData.forEach(activity => {
            if (activity.duration > 0) { // åªæ˜¾ç¤ºæœ‰æ—¶é•¿çš„è¿åŠ¨è®°å½•
                const activityTime = activity.time;
                console.log(`è¿åŠ¨æ—¶é—´: ${activityTime}, æ˜¯å¦å­˜åœ¨ç²¾ç¡®åŒ¹é…: ${labels.includes(activityTime)}`);
                
                // å°è¯•ç²¾ç¡®åŒ¹é…
                let activityIndex = labels.indexOf(activityTime);
                let glucoseValue = null;
                
                // å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ‰¾åˆ°æœ€æ¥è¿‘çš„æ—¶é—´ç‚¹ï¼ˆå‰å5åˆ†é’Ÿå†…ï¼‰
                if (activityIndex === -1) {
                    console.log(`ç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…è¿åŠ¨æ—¶é—´: ${activityTime}`);
                    const activityDateTime = new Date(activityTime);
                    
                    for (let i = 0; i < labels.length; i++) {
                        const labelDateTime = new Date(labels[i]);
                        const timeDiff = Math.abs(labelDateTime - activityDateTime);
                        const timeDiffMinutes = timeDiff / (1000 * 60);
                        
                        if (timeDiffMinutes <= 5) { // 5åˆ†é’Ÿå†…è®¤ä¸ºåŒ¹é…
                            activityIndex = i;
                            glucoseValue = values[i];
                            console.log(`æ‰¾åˆ°æ¨¡ç³ŠåŒ¹é…: ç´¢å¼•${i}, æ—¶é—´å·®${timeDiffMinutes.toFixed(1)}åˆ†é’Ÿ`);
                            break;
                        }
                    }
                } else {
                    glucoseValue = values[activityIndex];
                }
                
                if (activityIndex !== -1 && glucoseValue !== null) {
                    // å°†è¿åŠ¨å›¾æ ‡æ”¾ç½®åœ¨è¡€ç³–æ›²çº¿ä¸‹æ–¹ï¼Œé”™å¼€æ˜¾ç¤º
                    const activityIndexInArray = activityDataPoints.length;
                    const offsetValue = Math.max(0.5, glucoseValue - (0.8 + (activityIndexInArray % 3) * 0.4)); // é”™å¼€æ˜¾ç¤ºï¼Œé¿å…é‡å ï¼Œä¸”ä¸ä½äº0.5
                    const dataPoint = {
                        x: labels[activityIndex], // ä½¿ç”¨è¡€ç³–æ•°æ®çš„æ—¶é—´ç‚¹
                        y: offsetValue, // è°ƒæ•´åçš„Yåæ ‡ï¼Œåœ¨è¡€ç³–æ›²çº¿ä¸‹æ–¹
                        originalY: glucoseValue, // åŸå§‹è¡€ç³–å€¼ï¼Œç”¨äºæ˜¾ç¤º
                        duration: activity.duration,
                        event_type: activity.event_type || 'è¿åŠ¨',
                        notes: activity.notes || '', // æ·»åŠ å¤‡æ³¨å­—æ®µ
                        original_time: activityTime // åŸå§‹è¿åŠ¨æ—¶é—´ï¼Œç”¨äºè°ƒè¯•
                    };
                    activityDataPoints.push(dataPoint);
                    console.log(`æ·»åŠ è¿åŠ¨æ•°æ®ç‚¹:`, dataPoint);
                }
            }
        });
        
        console.log('æœ€ç»ˆé¤é£Ÿæ•°æ®ç‚¹:', mealDataPoints);
        console.log('æœ€ç»ˆè¿åŠ¨æ•°æ®ç‚¹:', activityDataPoints);
        
        console.log('å¼€å§‹åˆ›å»ºå›¾è¡¨ï¼Œé¤é£Ÿæ•°æ®ç‚¹æ•°é‡:', mealDataPoints.length);
        console.log('å¼€å§‹åˆ›å»ºå›¾è¡¨ï¼Œè¿åŠ¨æ•°æ®ç‚¹æ•°é‡:', activityDataPoints.length);
        console.log('é¤é£Ÿæ•°æ®ç‚¹ç¤ºä¾‹:', mealDataPoints.slice(0, 2));
        console.log('è¿åŠ¨æ•°æ®ç‚¹ç¤ºä¾‹:', activityDataPoints.slice(0, 2));
        
        // åˆ›å»ºè‡ªå®šä¹‰æ’ä»¶æ¥ç»˜åˆ¶å‚ç›´è™šçº¿
        const verticalLinePlugin = {
            id: 'verticalLinePlugin',
            afterDraw: function(chart) {
                const ctx = chart.ctx;
                const xScale = chart.scales.x;
                const yScale = chart.scales.y;
                
                // åˆå¹¶æ‰€æœ‰éœ€è¦ç»˜åˆ¶è™šçº¿çš„æ•°æ®ç‚¹
                const allDataPoints = [
                    ...mealDataPoints.map(point => ({...point, type: 'meal', color: '#fd7e14'})),
                    ...activityDataPoints.map(point => ({...point, type: 'activity', color: '#20c997'}))
                ];
                
                allDataPoints.forEach(dataPoint => {
                    // æ‰¾åˆ°å¯¹åº”æ—¶é—´ç‚¹çš„ç´¢å¼•
                    const xIndex = labels.indexOf(dataPoint.x);
                    if (xIndex !== -1) {
                        const x = xScale.getPixelForValue(xIndex);
                        const y = yScale.getPixelForValue(dataPoint.y);
                        const bottomY = chart.scales.y.bottom; // å›¾è¡¨åº•éƒ¨
                        
                        // ç»˜åˆ¶å‚ç›´è™šçº¿
                        ctx.save();
                        ctx.strokeStyle = dataPoint.color;
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 5]); // è™šçº¿æ ·å¼
                        ctx.globalAlpha = 0.6;
                        
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x, bottomY);
                        ctx.stroke();
                        
                        ctx.restore();
                    }
                });
            }
        };
        
        glucoseChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'è¡€ç³–å€¼ (mmol/L)',
                    data: values,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.1,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }, {
                    label: 'ç›®æ ‡èŒƒå›´ä¸Šé™',
                    data: new Array(labels.length).fill(10.0),
                    borderColor: '#28a745',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }, {
                    label: 'ç›®æ ‡èŒƒå›´ä¸‹é™',
                    data: new Array(labels.length).fill(3.9),
                    borderColor: '#28a745',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }, {
                    label: 'é¤é£Ÿè®°å½•',
                    data: mealDataPoints,
                    backgroundColor: '#fd7e14',
                    borderColor: '#fd7e14',
                    showLine: false,
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    pointStyle: 'triangle',
                    rotation: 0
                }, {
                    label: 'è¿åŠ¨è®°å½•',
                    data: activityDataPoints,
                    backgroundColor: '#20c997',
                    borderColor: '#20c997',
                    showLine: false,
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    pointStyle: 'rectRot',
                    rotation: 45
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: true,
                    mode: 'nearest'
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: Math.min(3.0, Math.min(...values) - 1),
                        max: Math.max(15.0, Math.max(...values) + 1),
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                size: window.innerWidth < 768 ? 10 : 12
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxTicksLimit: window.innerWidth < 768 ? 6 : 10,
                            font: {
                                size: window.innerWidth < 768 ? 10 : 12
                            },
                            maxRotation: window.innerWidth < 768 ? 45 : 0
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                plugins: {
                    // æ³¨å†Œè‡ªå®šä¹‰æ’ä»¶
                    ...[verticalLinePlugin],
                    legend: {
                        display: true,
                        position: window.innerWidth < 768 ? 'bottom' : 'top',
                        labels: {
                            font: {
                                size: window.innerWidth < 768 ? 10 : 12
                            },
                            usePointStyle: true,
                            padding: window.innerWidth < 768 ? 10 : 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: {
                            size: window.innerWidth < 768 ? 12 : 14
                        },
                        bodyFont: {
                            size: window.innerWidth < 768 ? 11 : 13
                        },
                        padding: window.innerWidth < 768 ? 8 : 12,
                        callbacks: {
                            title: function(tooltipItems) {
                                console.log('=== Titleå›è°ƒè°ƒç”¨ ===');
                                console.log('tooltipItems:', tooltipItems);
                                
                                if (!tooltipItems || tooltipItems.length === 0) {
                                    console.log('tooltipItemsä¸ºç©º');
                                    return '';
                                }
                                
                                const tooltipItem = tooltipItems[0];
                                console.log('tooltipItem:', tooltipItem);
                                
                                const datasetIndex = tooltipItem.datasetIndex;
                                const dataIndex = tooltipItem.dataIndex;
                                const dataset = tooltipItem.chart.data.datasets[datasetIndex];
                                const dataPoint = dataset.data[dataIndex];
                                
                                console.log('datasetIndex:', datasetIndex, 'dataIndex:', dataIndex);
                                console.log('dataPoint:', dataPoint);
                                
                                if (datasetIndex === 3 && dataPoint && dataPoint.originalY !== undefined) {
                                    console.log('è¿”å›é¤é£Ÿæ ‡é¢˜');
                                    return `ğŸ½ï¸ é¤é£Ÿè®°å½•`;
                                } else if (datasetIndex === 4 && dataPoint && dataPoint.originalY !== undefined) {
                                    console.log('è¿”å›è¿åŠ¨æ ‡é¢˜');
                                    return `ğŸƒ è¿åŠ¨è®°å½•`;
                                }
                                
                                console.log('è¿”å›é»˜è®¤æ ‡é¢˜:', dataset.label);
                                return dataset.label;
                            },
                            label: function(context) {
                                const datasetIndex = context.datasetIndex;
                                const dataIndex = context.dataIndex;
                                const dataset = context.chart.data.datasets[datasetIndex];
                                const dataPoint = dataset.data[dataIndex];
                                
                                if (datasetIndex === 3 && dataPoint && dataPoint.originalY !== undefined) {
                                    return [
                                        `ç¢³æ°´: ${dataPoint.carbs}g`,
                                        `ç±»å‹: ${dataPoint.event_type}`,
                                        `è¡€ç³–: ${dataPoint.originalY.toFixed(1)} mmol/L`
                                    ];
                                } else if (datasetIndex === 4 && dataPoint && dataPoint.originalY !== undefined) {
                                    console.log('=== è¿åŠ¨å·¥å…·æç¤ºè°ƒè¯• ===');
                                    console.log('æ•°æ®ç‚¹:', dataPoint);
                                    
                                    const exerciseType = dataPoint.event_type || 'è¿åŠ¨';
                                    const exerciseNotes = dataPoint.notes || '';
                                    
                                    console.log('è¿åŠ¨ç±»å‹:', exerciseType);
                                    console.log('è¿åŠ¨å¤‡æ³¨:', exerciseNotes);
                                    
                                    // æ„å»ºæ˜¾ç¤ºå†…å®¹ï¼Œä¸è¿åŠ¨è®°å½•è¡¨æ ¼ä¿æŒä¸€è‡´
                                    const durationDisplay = dataPoint.duration > 0 ? `${dataPoint.duration}åˆ†é’Ÿ` : '';
                                    const typeDisplay = exerciseType;
                                    
                                    // å¦‚æœevent_typeä¸­åŒ…å«" - "ï¼Œåˆ™å‰é¢éƒ¨åˆ†ä¸ºç±»å‹ï¼Œåé¢éƒ¨åˆ†ä¸ºå¤‡æ³¨
                                    let notesDisplay = exerciseNotes;
                                    if (!notesDisplay && exerciseType.includes(' - ')) {
                                        const parts = exerciseType.split(' - ');
                                        if (parts.length > 1) {
                                            notesDisplay = parts.slice(1).join(' - ');
                                        }
                                    }
                                    
                                    console.log('æœ€ç»ˆå¤‡æ³¨æ˜¾ç¤º:', notesDisplay);
                                    
                                    // å…ˆå°è¯•ç®€å•çš„å­—ç¬¦ä¸²è¿”å›
                                    let simpleResult = `æ—¶é•¿: ${durationDisplay} | ç±»å‹: ${typeDisplay}`;
                                    if (notesDisplay && notesDisplay.trim() !== '') {
                                        simpleResult += ` | å¤‡æ³¨: ${notesDisplay}`;
                                    }
                                    simpleResult += ` | è¡€ç³–: ${dataPoint.originalY.toFixed(1)} mmol/L`;
                                    
                                    console.log('ç®€å•ç»“æœå­—ç¬¦ä¸²:', simpleResult);
                                    
                                    // å†å°è¯•æ•°ç»„æ ¼å¼
                                    const result = [`æ—¶é•¿: ${durationDisplay}`, `ç±»å‹: ${typeDisplay}`];
                                    if (notesDisplay && notesDisplay.trim() !== '') {
                                        result.push(`å¤‡æ³¨: ${notesDisplay}`);
                                        console.log('æ·»åŠ å¤‡æ³¨è¡Œ:', notesDisplay);
                                    } else {
                                        console.log('å¤‡æ³¨ä¸ºç©ºï¼Œä¸æ·»åŠ ');
                                    }
                                    
                                    console.log('æ•°ç»„ç»“æœ:', result);
                                    
                                    // ä¸´æ—¶è¿”å›ç®€å•å­—ç¬¦ä¸²è¿›è¡Œæµ‹è¯•
                                    return simpleResult;
                                }
                                
                                return `${dataset.label}: ${context.parsed.y.toFixed(1)} mmol/L`;
                            },
                            afterLabel: function(context) {
                                const datasetIndex = context.datasetIndex;
                                const dataIndex = context.dataIndex;
                                const dataset = context.chart.data.datasets[datasetIndex];
                                const dataPoint = dataset.data[dataIndex];
                                
                                if (datasetIndex === 3 && dataPoint && dataPoint.originalY !== undefined) {
                                    return `æ—¶é—´: ${dataPoint.original_time}`;
                                } else if (datasetIndex === 4 && dataPoint && dataPoint.originalY !== undefined) {
                                    return `æ—¶é—´: ${dataPoint.original_time}`;
                                }
                                
                                return '';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // è·å–AIåˆ†æ
    function getAnalysis() {
        const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
        modal.show();
        
        document.getElementById('analysis-content').innerHTML = `
            <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i> åˆ†æä¸­ï¼Œè¯·ç¨å€™...
            </div>
        `;
        
        fetch(`/api/analysis?days=${currentDays}`)
            .then(response => response.json())
            .then(data => {
                if (data.analysis) {
                    document.getElementById('analysis-content').innerHTML = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> åˆ†æç»“æœ</h6>
                            <pre style="white-space: pre-wrap; font-family: inherit;">${data.analysis}</pre>
                        </div>
                    `;
                } else {
                    document.getElementById('analysis-content').innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle"></i> åˆ†æå¤±è´¥</h6>
                            <p>${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('analysis-content').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> åˆ†æå¤±è´¥</h6>
                        <p>ç½‘ç»œé”™è¯¯: ${error.message}</p>
                    </div>
                `;
            });
    }
    
    // å¤åˆ¶åˆ†æç»“æœ
    function copyAnalysis() {
        const content = document.querySelector('#analysis-content pre');
        if (content) {
            navigator.clipboard.writeText(content.textContent).then(() => {
                showNotification('åˆ†æç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        }
    }
    

    // æ‰“å¼€AIå’¨è¯¢æ¨¡æ€æ¡†
    function openAIConsult() {
        const modal = new bootstrap.Modal(document.getElementById('consultModal'));
        modal.show();

        // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
        document.getElementById('consultQuestion').value = '';
        document.getElementById('consult-response').style.display = 'none';
        document.getElementById('copyConsultBtn').style.display = 'none';
        document.getElementById('consultSubmitBtn').disabled = false;
    }

    // æäº¤AIå’¨è¯¢
    function submitConsult() {
        const question = document.getElementById('consultQuestion').value.trim();
        const includeData = document.getElementById('includeGlucoseData').checked;
        const submitBtn = document.getElementById('consultSubmitBtn');
        const originalText = submitBtn.innerHTML;

        if (!question) {
            showNotification('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜', 'warning');
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å’¨è¯¢ä¸­...';
        submitBtn.disabled = true;

        // æ˜¾ç¤ºå›å¤åŒºåŸŸ
        document.getElementById('consult-response').style.display = 'block';
        document.getElementById('consult-content').innerHTML = `
            <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨å€™...
            </div>
        `;

        // æ„å»ºè¯·æ±‚æ•°æ®
        const requestData = {
            question: question,
            include_data: includeData,
            days: currentDays
        };

        fetch('/api/ai-consult', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.response) {
                document.getElementById('consult-content').innerHTML = `
                    <div class="ai-response">
                        ${data.response.replace(/\n/g, '<br>')}
                    </div>
                `;
                document.getElementById('copyConsultBtn').style.display = 'inline-block';
                showNotification('AIå’¨è¯¢å®Œæˆ', 'success');
            } else {
                document.getElementById('consult-content').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> å’¨è¯¢å¤±è´¥</h6>
                        <p>${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                    </div>
                `;
                showNotification('AIå’¨è¯¢å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }
        })
        .catch(error => {
            document.getElementById('consult-content').innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> å’¨è¯¢å¤±è´¥</h6>
                    <p>ç½‘ç»œé”™è¯¯: ${error.message}</p>
                </div>
            `;
            showNotification('å’¨è¯¢å¤±è´¥: ' + error.message, 'danger');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }

    // å¤åˆ¶AIå’¨è¯¢å›å¤
    function copyConsultResponse() {
        const content = document.getElementById('consult-content').innerText;
        navigator.clipboard.writeText(content).then(() => {
            showNotification('å›å¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(() => {
            showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', 'warning');
        });
    }

    // ç”ŸæˆæŠ¥è¡¨
    function generateReport() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        let reportUrl = '/report';
        
        if (startDate && endDate) {
            // ä½¿ç”¨è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ', 'warning');
                return;
            }
            reportUrl += `?start_date=${startDate}&end_date=${endDate}`;
        } else {
            // ä½¿ç”¨å½“å‰å¤©æ•°
            const today = new Date().toISOString().split('T')[0];
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - (currentDays - 1));
            const startDateStr = startDate.toISOString().split('T')[0];
            reportUrl += `?start_date=${startDateStr}&end_date=${today}`;
        }
        
        // åœ¨æ–°çª—å£æ‰“å¼€æŠ¥è¡¨é¡µé¢
        window.open(reportUrl, '_blank');
    }
    
    // æ‰“å¼€æ¶ˆæ¯æ”¶ä»¶ç®±
    function openMessageInbox() {
        window.open('/messages', '_blank');
    }
    
    // æ›´æ–°æœªè¯»æ¶ˆæ¯æ•°é‡æŒ‡ç¤ºå™¨
    function updateUnreadCountIndicator() {
        fetch('/api/messages/unread-count')
            .then(response => response.json())
            .then(data => {
                const messageBtn = document.querySelector('button[onclick="openMessageInbox()"]');
                if (messageBtn && data.unread_count > 0) {
                    // ç§»é™¤å¯èƒ½å·²å­˜åœ¨çš„çº¢ç‚¹
                    const existingBadge = messageBtn.querySelector('.unread-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    // æ·»åŠ æ–°çš„çº¢ç‚¹
                    const badge = document.createElement('span');
                    badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger unread-badge';
                    badge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
                    messageBtn.appendChild(badge);
                    messageBtn.classList.add('position-relative');
                }
            })
            .catch(error => {
                console.error('è·å–æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥:', error);
            });
    }
</script>
{% endblock %}
