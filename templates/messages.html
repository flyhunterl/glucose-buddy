{% extends "base.html" %}

{% block title %}消息收件箱 - Nightscout 血糖监控{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-envelope"></i> 消息收件箱
                    {% if unread_count > 0 %}
                    <span class="badge bg-danger ms-2">{{ unread_count }}</span>
                    {% endif %}
                </h5>
                <div class="d-flex align-items-center">
                    <div class="btn-group me-2">
                        <button class="btn btn-outline-primary btn-sm active" onclick="filterMessages('all')">
                            全部
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="filterMessages('analysis')">
                            AI分析
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="filterMessages('consultation')">
                            AI咨询
                        </button>
                    </div>
                    <!-- 批量操作工具栏 -->
                    <div id="batchToolbar" class="btn-group d-none">
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedMessages()" title="删除选中">
                            <i class="fas fa-trash"></i> 删除选中
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()" title="取消选择">
                            <i class="fas fa-times"></i> 取消选择
                        </button>
                        <span class="ms-2 align-self-center">
                            <small class="text-muted">已选择 <span id="selectedCount">0</span> 条</small>
                        </span>
                    </div>
                    <!-- 全选按钮 -->
                    <button id="selectAllBtn" class="btn btn-outline-secondary btn-sm ms-2 d-none" onclick="toggleSelectAll()" title="全选/取消全选">
                        <i class="fas fa-check-square"></i> 全选
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="messages-container">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 消息详情模态框 -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalTitle">消息详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="messageModalContent">
                    <!-- 消息内容 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="copyMessageContent()">
                    <i class="fas fa-copy"></i> 复制内容
                </button>
                <button type="button" class="btn btn-warning" id="favoriteBtn" onclick="toggleFavorite()">
                    <i class="fas fa-star"></i> 收藏
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteMessage()">
                    <i class="fas fa-trash"></i> 删除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentMessages = [];
    let currentFilter = 'all';
    let currentMessageId = null;
    let selectedMessageIds = new Set();

    // 增强的Markdown表格解析函数
    function parseMarkdownTables(text) {
        const tableRegex = /(\|.*\|)\n(\|[\s\-\|:]+\|)\n((\|.*\|\n?)+)/g;
        
        return text.replace(tableRegex, function(match, headerRow, separatorRow, bodyRows) {
            // 处理表头
            const headers = headerRow.split('|').filter(cell => cell.trim() !== '').map(cell => cell.trim());
            
            // 处理表体
            const rows = bodyRows.trim().split('\n').map(row => 
                row.split('|').filter(cell => cell.trim() !== '').map(cell => cell.trim())
            );
            
            // 分析对齐方式
            const alignmentRow = separatorRow.split('|').filter(cell => cell.trim() !== '');
            const alignments = alignmentRow.map(cell => {
                const trimmed = cell.trim();
                if (trimmed.startsWith(':') && trimmed.endsWith(':')) return 'center';
                if (trimmed.endsWith(':')) return 'right';
                return 'left';
            });
            
            // 构建增强的HTML表格
            let html = '<table class="table table-striped table-bordered table-hover table-responsive markdown-table">';
            
            // 表头
            html += '<thead class="markdown-thead"><tr class="markdown-tr">';
            headers.forEach((header, index) => {
                const align = alignments[index] || 'left';
                const alignClass = align === 'center' ? 'text-center' : align === 'right' ? 'text-end' : 'text-start';
                html += `<th class="${alignClass} markdown-th">${header}</th>`;
            });
            html += '</tr></thead>';
            
            // 表体
            html += '<tbody class="markdown-tbody">';
            rows.forEach(row => {
                html += '<tr class="markdown-tr">';
                row.forEach((cell, index) => {
                    const align = alignments[index] || 'left';
                    const alignClass = align === 'center' ? 'text-center' : align === 'right' ? 'text-end' : 'text-start';
                    html += `<td class="${alignClass} markdown-td">${cell}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            
            html += '</table>';
            return html;
        });
    }
    
    // 增强的Markdown解析函数
    function parseMarkdown(text) {
        // 转义HTML
        text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        // 表格处理（需要在其他处理之前）
        text = parseMarkdownTables(text);
        
        // 标题
        text = text.replace(/^###### (.*$)/gm, '<h6 class="markdown-h6">$1</h6>');
        text = text.replace(/^##### (.*$)/gm, '<h5 class="markdown-h5">$1</h5>');
        text = text.replace(/^#### (.*$)/gm, '<h4 class="markdown-h4">$1</h4>');
        text = text.replace(/^### (.*$)/gm, '<h3 class="markdown-h3">$1</h3>');
        text = text.replace(/^## (.*$)/gm, '<h2 class="markdown-h2">$1</h2>');
        text = text.replace(/^# (.*$)/gm, '<h1 class="markdown-h1">$1</h1>');
        
        // 无序列表
        text = text.replace(/^\* (.*$)/gm, '<li class="markdown-li">$1</li>');
        text = text.replace(/^- (.*$)/gm, '<li class="markdown-li">$1</li>');
        text = text.replace(/^\+ (.*$)/gm, '<li class="markdown-li">$1</li>');
        
        // 有序列表
        text = text.replace(/^\d+\. (.*$)/gm, '<li class="markdown-li">$1</li>');
        
        // 包装列表项 - 改进的正则表达式处理连续列表项
        text = text.replace(/(<li class="markdown-li">.*<\/li>)(\s*<li class="markdown-li">.*<\/li>)*/gs, function(match) {
            return '<ul class="markdown-ul">' + match + '</ul>';
        });
        
        // 代码块 - 增强语法高亮支持
        text = text.replace(/```([\s\S]*?)```/g, '<pre class="markdown-pre"><code class="markdown-code">$1</code></pre>');
        
        // 行内代码
        text = text.replace(/`([^`]+)`/g, '<code class="markdown-inline-code">$1</code>');
        
        // 链接
        text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="markdown-link">$1</a>');
        
        // 图片
        text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" class="markdown-image">');
        
        // 粗体
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="markdown-strong">$1</strong>');
        text = text.replace(/__(.*?)__/g, '<strong class="markdown-strong">$1</strong>');
        
        // 斜体
        text = text.replace(/\*(.*?)\*/g, '<em class="markdown-em">$1</em>');
        text = text.replace(/_(.*?)_/g, '<em class="markdown-em">$1</em>');
        
        // 删除线
        text = text.replace(/~~(.*?)~~/g, '<del class="markdown-del">$1</del>');
        
        // 引用块
        text = text.replace(/^> (.*$)/gm, '<blockquote class="markdown-blockquote">$1</blockquote>');
        
        // 换行处理 - 改进的换行逻辑
        text = text.replace(/\n\n/g, '</p><p class="markdown-paragraph">');
        text = text.replace(/\n/g, '<br class="markdown-br">');
        
        // 包装段落
        text = '<p class="markdown-paragraph">' + text + '</p>';
        
        return text;
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadMessages();
        updateUnreadCount();
    });

    // 加载消息列表
    function loadMessages() {
        const url = currentFilter === 'all' 
            ? '/api/messages' 
            : `/api/messages?type=${currentFilter}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.messages) {
                    currentMessages = data.messages;
                    renderMessages(data.messages);
                } else {
                    document.getElementById('messages-container').innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-inbox"></i> 暂无消息
                        </div>
                    `;
                }
                // 重置选择状态
                clearSelection();
            })
            .catch(error => {
                console.error('加载消息失败:', error);
                document.getElementById('messages-container').innerHTML = `
                    <div class="alert alert-danger">
                        加载消息失败: ${error.message}
                    </div>
                `;
            });
    }

    // 更新选择状态UI
    function updateSelectionUI() {
        const checkboxes = document.querySelectorAll('.message-checkbox');
        const selectedCheckboxes = document.querySelectorAll('.message-checkbox:checked');
        
        // 更新选中的消息ID集合
        selectedMessageIds.clear();
        selectedCheckboxes.forEach(checkbox => {
            selectedMessageIds.add(parseInt(checkbox.value));
        });
        
        // 更新选择计数
        document.getElementById('selectedCount').textContent = selectedMessageIds.size;
        
        // 显示/隐藏工具栏和全选按钮
        const batchToolbar = document.getElementById('batchToolbar');
        const selectAllBtn = document.getElementById('selectAllBtn');
        
        if (checkboxes.length > 0) {
            selectAllBtn.classList.remove('d-none');
        } else {
            selectAllBtn.classList.add('d-none');
        }
        
        if (selectedMessageIds.size > 0) {
            batchToolbar.classList.remove('d-none');
        } else {
            batchToolbar.classList.add('d-none');
        }
    }

    // 全选/取消全选
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.message-checkbox');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const allSelected = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = !allSelected;
        });
        
        // 更新按钮图标
        const icon = selectAllBtn.querySelector('i');
        if (allSelected) {
            icon.className = 'fas fa-square';
            selectAllBtn.title = '全选';
        } else {
            icon.className = 'fas fa-check-square';
            selectAllBtn.title = '取消全选';
        }
        
        updateSelectionUI();
    }

    // 清除选择
    function clearSelection() {
        const checkboxes = document.querySelectorAll('.message-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectedMessageIds.clear();
        updateSelectionUI();
        
        // 重置全选按钮
        const selectAllBtn = document.getElementById('selectAllBtn');
        const icon = selectAllBtn.querySelector('i');
        icon.className = 'fas fa-check-square';
        selectAllBtn.title = '全选';
    }

    // 批量删除选中的消息
    function deleteSelectedMessages() {
        if (selectedMessageIds.size === 0) {
            showNotification('请选择要删除的消息', 'warning');
            return;
        }
        
        if (confirm(`确定要删除选中的 ${selectedMessageIds.size} 条消息吗？`)) {
            const messageIdsArray = Array.from(selectedMessageIds);
            
            fetch('/api/messages/batch', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message_ids: messageIdsArray
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 从当前消息列表中移除已删除的消息
                    currentMessages = currentMessages.filter(m => !selectedMessageIds.has(m.id));
                    renderMessages(currentMessages);
                    updateUnreadCount();
                    
                    // 清除选择状态
                    clearSelection();
                    
                    showNotification(data.message, 'success');
                } else {
                    showNotification('批量删除失败: ' + (data.error || '未知错误'), 'danger');
                }
            })
            .catch(error => {
                console.error('批量删除消息失败:', error);
                showNotification('批量删除失败: ' + error.message, 'danger');
            });
        }
    }

    // 渲染消息列表
    function renderMessages(messages) {
        const container = document.getElementById('messages-container');
        
        if (messages.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-inbox"></i> 暂无消息
                </div>
            `;
            return;
        }

        container.innerHTML = messages.map(message => {
            const typeIcon = message.type === 'analysis' ? 'fa-brain' : 'fa-comments';
            const typeText = message.type === 'analysis' ? 'AI分析' : 'AI咨询';
            const unreadClass = message.is_read ? '' : 'unread-message';
            const favoriteIcon = message.is_favorite ? 'fas' : 'far';
            // 使用北京时间显示
            const displayTime = message.created_at_beijing || formatDateTime(message.created_at);
            
            return `
                <div class="card mb-3 message-card ${unreadClass}" data-id="${message.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <!-- 复选框 -->
                                    <div class="form-check me-2">
                                        <input class="form-check-input message-checkbox" 
                                               type="checkbox" 
                                               value="${message.id}" 
                                               onchange="updateSelectionUI()">
                                    </div>
                                    <i class="fas ${typeIcon} me-2 text-primary"></i>
                                    <h6 class="card-title mb-0">${message.title}</h6>
                                    <span class="badge bg-secondary ms-2">${typeText}</span>
                                    ${!message.is_read ? '<span class="badge bg-danger ms-1">未读</span>' : ''}
                                </div>
                                <p class="card-text text-muted">${message.content.substring(0, 100)}${message.content.length > 100 ? '...' : ''}</p>
                                <small class="text-muted">${displayTime}</small>
                            </div>
                            <div class="ms-3">
                                <button class="btn btn-outline-warning btn-sm me-1" onclick="toggleFavoriteQuick(${message.id})" title="收藏">
                                    <i class="${favoriteIcon} fa-star"></i>
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="viewMessage(${message.id})" title="查看详情">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // 查看消息详情
    function viewMessage(messageId) {
        const message = currentMessages.find(m => m.id === messageId);
        if (!message) return;

        currentMessageId = messageId;
        
        // 标记为已读
        if (!message.is_read) {
            updateMessageStatus(messageId, { is_read: true });
            message.is_read = true;
            renderMessages(currentMessages);
            updateUnreadCount();
        }

        // 显示模态框
        document.getElementById('messageModalTitle').textContent = message.title;
        document.getElementById('messageModalContent').innerHTML = `
            <div class="message-content">
                ${parseMarkdown(message.content)}
            </div>
            <hr>
            <small class="text-muted">
                类型: ${message.type === 'analysis' ? 'AI分析' : 'AI咨询'} | 
                创建时间: ${formatDateTime(message.created_at)}
            </small>
        `;

        // 更新收藏按钮状态
        const favoriteBtn = document.getElementById('favoriteBtn');
        if (message.is_favorite) {
            favoriteBtn.innerHTML = '<i class="fas fa-star"></i> 取消收藏';
            favoriteBtn.classList.remove('btn-warning');
            favoriteBtn.classList.add('btn-outline-warning');
        } else {
            favoriteBtn.innerHTML = '<i class="fas fa-star"></i> 收藏';
            favoriteBtn.classList.remove('btn-outline-warning');
            favoriteBtn.classList.add('btn-warning');
        }

        const modal = new bootstrap.Modal(document.getElementById('messageModal'));
        modal.show();
    }

    // 切换收藏状态
    function toggleFavorite() {
        if (!currentMessageId) return;
        
        const message = currentMessages.find(m => m.id === currentMessageId);
        if (!message) return;

        const newFavoriteStatus = !message.is_favorite;
        updateMessageStatus(currentMessageId, { is_favorite: newFavoriteStatus });
        
        message.is_favorite = newFavoriteStatus;
        renderMessages(currentMessages);
        
        // 更新按钮状态
        const favoriteBtn = document.getElementById('favoriteBtn');
        if (newFavoriteStatus) {
            favoriteBtn.innerHTML = '<i class="fas fa-star"></i> 取消收藏';
            favoriteBtn.classList.remove('btn-warning');
            favoriteBtn.classList.add('btn-outline-warning');
        } else {
            favoriteBtn.innerHTML = '<i class="fas fa-star"></i> 收藏';
            favoriteBtn.classList.remove('btn-outline-warning');
            favoriteBtn.classList.add('btn-warning');
        }
    }

    // 快速切换收藏状态
    function toggleFavoriteQuick(messageId) {
        const message = currentMessages.find(m => m.id === messageId);
        if (!message) return;

        const newFavoriteStatus = !message.is_favorite;
        updateMessageStatus(messageId, { is_favorite: newFavoriteStatus });
        
        message.is_favorite = newFavoriteStatus;
        renderMessages(currentMessages);
    }

    // 复制消息内容
    function copyMessageContent() {
        const content = document.getElementById('messageModalContent').innerText;
        navigator.clipboard.writeText(content).then(() => {
            showNotification('内容已复制到剪贴板', 'success');
        }).catch(() => {
            showNotification('复制失败，请手动选择复制', 'warning');
        });
    }

    // 删除消息
    function deleteMessage() {
        if (!currentMessageId) return;
        
        if (confirm('确定要删除这条消息吗？')) {
            fetch(`/api/messages/${currentMessageId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 从列表中移除消息
                    currentMessages = currentMessages.filter(m => m.id !== currentMessageId);
                    renderMessages(currentMessages);
                    updateUnreadCount();
                    
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('messageModal'));
                    modal.hide();
                    
                    showNotification('消息已删除', 'success');
                } else {
                    showNotification('删除失败: ' + (data.error || '未知错误'), 'danger');
                }
            })
            .catch(error => {
                console.error('删除消息失败:', error);
                showNotification('删除失败: ' + error.message, 'danger');
            });
        }
    }

    // 更新消息状态
    function updateMessageStatus(messageId, updates) {
        fetch(`/api/messages/${messageId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updates)
        })
        .catch(error => {
            console.error('更新消息状态失败:', error);
        });
    }

    // 筛选消息
    function filterMessages(type) {
        currentFilter = type;
        
        // 更新按钮状态
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('active', 'btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        event.target.classList.remove('btn-outline-primary');
        event.target.classList.add('btn-primary', 'active');
        
        // 清除选择状态
        clearSelection();
        
        // 重新加载消息
        loadMessages();
    }

    // 更新未读消息数量
    function updateUnreadCount() {
        fetch('/api/messages/unread-count')
            .then(response => response.json())
            .then(data => {
                const badge = document.querySelector('.badge.bg-danger');
                if (data.unread_count > 0) {
                    if (badge) {
                        badge.textContent = data.unread_count;
                    } else {
                        const title = document.querySelector('.card-title');
                        title.innerHTML += ` <span class="badge bg-danger ms-2">${data.unread_count}</span>`;
                    }
                } else if (badge) {
                    badge.remove();
                }
            })
            .catch(error => {
                console.error('获取未读消息数量失败:', error);
            });
    }

        
    
    // 格式化日期时间
    function formatDateTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // 显示通知
    function showNotification(message, type = 'info') {
        // 创建通知元素
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // 3秒后自动关闭
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>

<style>
    .unread-message {
        border-left: 4px solid #dc3545;
        background-color: #fff5f5;
    }
    
    .message-content {
        font-family: inherit;
        line-height: 1.5;
        color: #333;
    }
    
    .message-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
    }
    
    /* 统一的标题样式 */
    .message-content h1, .message-content h2, .message-content h3, 
    .message-content h4, .message-content h5, .message-content h6 {
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
    }

    .message-content h1 { font-size: 1.5rem; margin-top: 1rem; }
    .message-content h2 { font-size: 1.3rem; margin-top: 0.8rem; }
    .message-content h3 { font-size: 1.2rem; margin-top: 0.7rem; }
    .message-content h4 { font-size: 1.1rem; margin-top: 0.6rem; }
    .message-content h5 { font-size: 1rem; margin-top: 0.5rem; }
    .message-content h6 { font-size: 0.9rem; margin-top: 0.4rem; }

    /* 统一的列表样式 */
    .message-content ul, .message-content ol {
        margin: 0.4rem 0;
        padding-left: 1.25rem;
    }

    .message-content li {
        margin: 0.15rem 0;
        line-height: 1.4;
    }

    /* 统一的代码块样式 */
    .message-content pre {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 0.875rem;
        overflow-x: auto;
        margin: 0.75rem 0;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }

    .message-content code {
        background-color: #f1f3f5;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 0.15rem 0.35rem;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.88rem;
        color: #d63384;
    }

    .message-content pre code {
        background-color: transparent;
        border: none;
        padding: 0;
        color: #495057;
    }

    /* 统一的引用样式 */
    .message-content blockquote {
        border-left: 4px solid #0d6efd;
        padding-left: 1rem;
        margin: 0.75rem 0;
        color: #6c757d;
        font-style: italic;
        background-color: #f8f9fa;
        border-radius: 0 4px 4px 0;
    }

    /* 统一的表格样式 */
    .message-content table {
        width: 100%;
        margin: 0.75rem 0;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 6px;
        overflow: hidden;
    }

    .message-content th, .message-content td {
        border: 1px solid #dee2e6;
        padding: 0.625rem;
        text-align: left;
        vertical-align: middle;
    }

    .message-content th {
        background-color: #0d6efd;
        color: white;
        font-weight: 600;
        border-bottom: 2px solid #0a58ca;
    }

    .message-content table tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .message-content table tr:hover {
        background-color: #e9ecef;
    }

    /* 统一的链接样式 */
    .message-content a {
        color: #0d6efd;
        text-decoration: none;
        font-weight: 500;
    }

    .message-content a:hover {
        color: #0a58ca;
        text-decoration: underline;
    }

    /* 统一的图片样式 */
    .message-content img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        margin: 0.5rem 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* 段落样式优化 */
    .message-content p {
        margin: 0.5rem 0;
        line-height: 1.5;
    }

    .message-content p:first-child {
        margin-top: 0;
    }

    .message-content p:last-child {
        margin-bottom: 0;
    }

    /* 换行样式优化 */
    .message-content br {
        content: '';
        display: block;
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}