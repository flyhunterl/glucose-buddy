<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}糖小助{% endblock %}</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="血糖监控">
    <meta name="msapplication-TileColor" content="#007bff">
    <meta name="msapplication-config" content="/static/browserconfig.xml">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">

    <!-- Icons -->
    <link rel="icon" href="{{ url_for('static', filename='ico.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='ico.png') }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" 
          onerror="this.onerror=null;this.href='https://unpkg.com/bootstrap@5.1.3/dist/css/bootstrap.min.css'">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"
          onerror="this.onerror=null;this.href='https://unpkg.com/@fortawesome/fontawesome-free@6.0.0/css/all.min.css'">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" 
            onerror="this.onerror=null;this.src='https://unpkg.com/chart.js@3.9.1/dist/chart.min.js'"></script>
    <!-- Chart.js Zoom Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"
            onerror="this.onerror=null;this.src='https://unpkg.com/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js'"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"
            onerror="this.onerror=null;this.src='https://unpkg.com/socket.io@4.5.0/client-dist/socket.io.min.js'"></script>
    
    <style>
        .glucose-high { color: #dc3545; font-weight: bold; }
        .glucose-normal { color: #28a745; }
        .glucose-low { color: #ffc107; font-weight: bold; }
        .direction-arrow { font-size: 1.2em; }
        .notification-toast { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .table-responsive { max-height: 600px; overflow-y: auto; }
        .sticky-header th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
        .loading { text-align: center; padding: 20px; }
        .card-header { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .btn-group-sm .btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; }

        /* 移动端优化 */
        @media (max-width: 576px) {
            .container { padding-left: 10px; padding-right: 10px; }
            .card-body { padding: 0.75rem; }
            .btn-group .btn { font-size: 0.875rem; padding: 0.375rem 0.5rem; }
            .table td { padding: 0.5rem 0.25rem; font-size: 0.875rem; }
            .badge { font-size: 0.75rem; margin-bottom: 2px; }
            .card-title { font-size: 1rem; }
            h4 { font-size: 1.25rem; }
            h6 { font-size: 0.875rem; }
            .notification-toast { right: 10px; left: 10px; width: auto; }
            .table-responsive { max-height: 300px; }
            .navbar-brand { font-size: 1.1rem; }
            .nav-link { font-size: 0.9rem; }
        }

        @media (max-width: 768px) {
            .table-responsive { max-height: 400px; }
            .btn-group .btn { padding: 0.375rem 0.75rem; }
        }

        /* 血糖值颜色增强 */
        .text-danger { color: #dc3545 !important; font-weight: 600; }
        .text-warning { color: #fd7e14 !important; font-weight: 600; }
        .text-success { color: #198754 !important; font-weight: 600; }
        .text-purple { color: #6f42c1 !important; font-weight: 600; }

        /* 移动端表格优化 */
        .mobile-glucose-row {
            border-left: 4px solid #dee2e6;
            margin-bottom: 0.5rem;
        }
        .mobile-glucose-row.high { border-left-color: #dc3545; }
        .mobile-glucose-row.normal { border-left-color: #198754; }
        .mobile-glucose-row.low { border-left-color: #fd7e14; }

        /* 图表触摸优化 */
        .chart-container {
            touch-action: pan-y;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .chart-container canvas {
            touch-action: pan-y pinch-zoom;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* 移动端表格触摸优化 */
        @media (max-width: 768px) {
            .table-responsive {
                -webkit-overflow-scrolling: touch;
                touch-action: pan-y pan-x;
                overflow-x: auto;
                overflow-y: auto;
                /* 增强兼容性 */
                -ms-touch-action: pan-y pan-x;
                /* 确保滚动容器正确渲染 */
                position: relative;
                /* 优化滚动性能 */
                will-change: scroll-position;
            }
            
            .table td {
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0, 123, 255, 0.2);
                user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                /* 增强触摸响应 */
                -webkit-touch-callout: none;
                /* 优化点击区域 */
                min-height: 44px; /* iOS推荐的最小点击区域 */
                /* 确保内容不被意外选择 */
                -webkit-user-drag: none;
                -khtml-user-drag: none;
                -moz-user-drag: none;
                -o-user-drag: none;
                user-drag: none;
            }
            
            /* 图表容器触摸优化 */
            .chart-container {
                touch-action: pan-y pinch-zoom;
                cursor: grab;
            }
            
            .chart-container.zooming {
                cursor: grabbing;
            }
            
            /* 表格行选择优化 */
            .table tbody tr {
                cursor: pointer;
                transition: background-color 0.2s ease;
                -webkit-tap-highlight-color: rgba(0, 123, 255, 0.3);
            }
            
            .table tbody tr:hover {
                background-color: rgba(0, 123, 255, 0.075);
            }
            
            .table tbody tr.selected {
                background-color: rgba(0, 123, 255, 0.15);
                border-left: 3px solid #007bff;
            }
            
            .table tbody tr:active {
                background-color: rgba(0, 123, 255, 0.2);
                transform: scale(0.995);
            }
            
            /* 移动端滚动优化 */
            .table-responsive.scrolling {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            .table-responsive.scrolling .table tbody tr {
                pointer-events: none;
            }
            
            .table-responsive.scrolling .table tbody tr.selected {
                pointer-events: auto;
            }
        }
        
        /* 桌面端表格选择优化 */
        @media (min-width: 769px) {
            .table-responsive {
                /* 确保桌面端滚动正常 */
                overflow-x: auto;
                overflow-y: auto;
            }
            
            .table tbody tr {
                cursor: pointer;
                transition: all 0.2s ease;
                /* 确保桌面端交互正常 */
                pointer-events: auto;
            }
            
            .table tbody tr:hover {
                background-color: rgba(0, 123, 255, 0.075);
                transform: translateX(2px);
            }
            
            .table tbody tr.selected {
                background-color: rgba(0, 123, 255, 0.15);
                border-left: 4px solid #007bff;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .table tbody tr:active {
                background-color: rgba(0, 123, 255, 0.2);
                transform: translateX(1px) scale(0.998);
            }
        }
        
        /* 平板端优化 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .chart-container {
                touch-action: pan-y pinch-zoom;
            }
        }
        
        /* PC桌面端优化 */
        @media (min-width: 1025px) {
            /* 表格GPU加速 */
            .table-responsive {
                transform: translateZ(0);
                will-change: transform;
                backface-visibility: hidden;
                perspective: 1000px;
            }
            
            .table tbody tr {
                transform: translateZ(0);
                will-change: background-color, transform;
                backface-visibility: hidden;
                transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .table tbody tr:hover {
                background-color: rgba(0, 123, 255, 0.08);
                transform: translateX(3px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .table tbody tr.selected {
                background-color: rgba(0, 123, 255, 0.12);
                border-left: 4px solid #007bff;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transform: translateX(2px);
            }
            
            /* 表格加载指示器GPU加速 */
            .table-loading {
                transform: translateZ(0);
                will-change: opacity;
                backface-visibility: hidden;
                animation: tableLoadingPulse 1.5s ease-in-out infinite;
            }
            
            @keyframes tableLoadingPulse {
                0%, 100% { opacity: 0.6; }
                50% { opacity: 1; }
            }
            
            /* 图表拖拽优化 */
            .chart-container {
                cursor: grab;
                transform: translateZ(0);
                will-change: transform;
                backface-visibility: hidden;
            }
            
            .chart-container.panning {
                cursor: grabbing;
                transform: translateZ(0);
                will-change: transform;
            }
            
            .chart-container canvas {
                transform: translateZ(0);
                will-change: transform;
                backface-visibility: hidden;
            }
            
            /* 平滑过渡 */
            .chart-container * {
                transition: transform 0.1s ease-out;
            }
        }
        
        /* 通用GPU加速类 */
        .gpu-accelerated {
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        .smooth-transition {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .desktop-hover-effect {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .desktop-hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* 表格行增强 */
        .table-row-enhanced {
            transform: translateZ(0);
            will-change: background-color, transform, box-shadow;
            backface-visibility: hidden;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .table-row-enhanced:hover {
            background-color: rgba(0, 123, 255, 0.08);
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .table-row-enhanced.selected {
            background-color: rgba(0, 123, 255, 0.12);
            border-left: 4px solid #007bff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(2px);
        }
        
        /* 图表锚点拖动样式 */
        .chart-anchor-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #007bff;
            border: 2px solid #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.4);
            transition: all 0.2s ease;
            pointer-events: none;
        }

        .chart-anchor-point.active {
            width: 16px;
            height: 16px;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.3);
            animation: anchorPulse 1.5s infinite;
        }

        @keyframes anchorPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }

        /* 图表触摸反馈样式 */
        .chart-container.touch-active {
            background: rgba(0, 123, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .chart-container.touch-pressing {
            background: rgba(0, 123, 255, 0.1);
            box-shadow: inset 0 0 20px rgba(0, 123, 255, 0.1);
        }

        .chart-container canvas.touch-active {
            opacity: 0.95;
            transform: scale(0.998);
        }

        /* 移动端触摸优化增强 */
        @media (max-width: 768px) {
            .chart-container {
                position: relative;
            }
            
            .chart-container::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: 8px;
                background: transparent;
                transition: all 0.2s ease;
                pointer-events: none;
                z-index: 1;
            }
            
            .chart-container.touch-active::before {
                background: rgba(0, 123, 255, 0.08);
                border: 2px solid rgba(0, 123, 255, 0.2);
            }
            
            .chart-container.touch-pressing::before {
                background: rgba(0, 123, 255, 0.15);
                border: 2px solid rgba(0, 123, 255, 0.4);
            }
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='ico.png') }}" alt="Logo" style="height: 24px; margin-right: 5px;"> 糖小助
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'index' %}active{% endif %}" href="{{ url_for('index') }}">
                            <i class="fas fa-chart-line"></i> 血糖数据
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'config_page' %}active{% endif %}" href="{{ url_for('config_page') }}">
                            <i class="fas fa-cog"></i> 配置
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="syncData()">
                            <i class="fas fa-sync-alt"></i> 同步数据
                        </button>
                    </li>
                    <li class="nav-item ms-2">
                        <button class="btn btn-outline-light btn-sm" onclick="subscribeNotifications()">
                            <i class="fas fa-bell"></i> 订阅通知
                        </button>
                    </li>
                    {% if session['logged_in'] %}
                    <li class="nav-item ms-2">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-sign-out-alt"></i> 登出
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container mt-4">
        <!-- 通知区域 -->
        <div id="notification-area"></div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            onerror="this.onerror=null;this.src='https://unpkg.com/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js'"></script>
    
    <!-- CSS加载检测和备用样式 -->
    <script>
        // 检测CSS是否加载完成，如果未加载则使用备用样式
        function checkCSSLoaded() {
            const testElement = document.createElement('div');
            testElement.className = 'd-none';
            document.body.appendChild(testElement);
            
            // 检查Bootstrap是否加载
            const isBootstrapLoaded = window.getComputedStyle(testElement).display === 'none';
            
            document.body.removeChild(testElement);
            
            if (!isBootstrapLoaded) {
                console.warn('Bootstrap CSS failed to load, applying emergency styles');
                applyEmergencyStyles();
            }
        }
        
        // 应急样式 - 当外部CSS加载失败时使用
        function applyEmergencyStyles() {
            const emergencyStyle = document.createElement('style');
            emergencyStyle.textContent = `
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    line-height: 1.6;
                    margin: 0;
                    padding: 0;
                    background-color: #f8f9fa;
                }
                
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 0 15px;
                }
                
                .navbar {
                    background-color: #007bff;
                    padding: 1rem 0;
                    color: white;
                }
                
                .navbar-brand {
                    color: white !important;
                    text-decoration: none;
                    font-weight: bold;
                    font-size: 1.25rem;
                }
                
                .card {
                    background: white;
                    border: 1px solid #dee2e6;
                    border-radius: 0.375rem;
                    margin-bottom: 1rem;
                    padding: 1rem;
                    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
                }
                
                .card-header {
                    background-color: #f8f9fa;
                    border-bottom: 1px solid #dee2e6;
                    padding: 0.75rem 1rem;
                    margin-bottom: 1rem;
                    font-weight: bold;
                }
                
                .btn {
                    display: inline-block;
                    font-weight: 400;
                    line-height: 1.5;
                    color: #212529;
                    text-align: center;
                    text-decoration: none;
                    vertical-align: middle;
                    cursor: pointer;
                    background-color: #007bff;
                    border: 1px solid #007bff;
                    padding: 0.375rem 0.75rem;
                    font-size: 1rem;
                    border-radius: 0.375rem;
                    color: white;
                }
                
                .btn:hover {
                    background-color: #0056b3;
                    border-color: #0056b3;
                }
                
                .btn-outline-light {
                    background-color: transparent;
                    border-color: #f8f9fa;
                    color: #f8f9fa;
                }
                
                .btn-outline-light:hover {
                    background-color: #f8f9fa;
                    color: #007bff;
                }
                
                .table {
                    width: 100%;
                    margin-bottom: 1rem;
                    color: #212529;
                    border-collapse: collapse;
                }
                
                .table th,
                .table td {
                    padding: 0.75rem;
                    vertical-align: top;
                    border-top: 1px solid #dee2e6;
                    text-align: left;
                }
                
                .table thead th {
                    vertical-align: bottom;
                    border-bottom: 2px solid #dee2e6;
                    background-color: #f8f9fa;
                }
                
                .alert {
                    position: relative;
                    padding: 1rem;
                    margin-bottom: 1rem;
                    border: 1px solid transparent;
                    border-radius: 0.375rem;
                }
                
                .alert-info {
                    color: #0c5460;
                    background-color: #d1ecf1;
                    border-color: #bee5eb;
                }
                
                .alert-success {
                    color: #155724;
                    background-color: #d4edda;
                    border-color: #c3e6cb;
                }
                
                .alert-danger {
                    color: #721c24;
                    background-color: #f8d7da;
                    border-color: #f5c6cb;
                }
                
                .text-danger {
                    color: #dc3545 !important;
                    font-weight: 600;
                }
                
                .text-success {
                    color: #198754 !important;
                    font-weight: 600;
                }
                
                .text-warning {
                    color: #fd7e14 !important;
                    font-weight: 600;
                }
                
                .mt-4 {
                    margin-top: 1.5rem !important;
                }
                
                .mb-3 {
                    margin-bottom: 1rem !important;
                }
                
                .ms-2 {
                    margin-left: 0.5rem !important;
                }
                
                .me-auto {
                    margin-right: auto !important;
                }
                
                .d-flex {
                    display: flex !important;
                }
                
                .justify-content-between {
                    justify-content: space-between !important;
                }
                
                .align-items-center {
                    align-items: center !important;
                }
                
                .navbar-nav {
                    display: flex;
                    list-style: none;
                    margin: 0;
                    padding: 0;
                }
                
                .nav-item {
                    margin-left: 1rem;
                }
                
                .nav-link {
                    color: rgba(255,255,255,0.8) !important;
                    text-decoration: none;
                    padding: 0.5rem 1rem;
                }
                
                .nav-link:hover,
                .nav-link.active {
                    color: white !important;
                }
                
                .bg-primary {
                    background-color: #007bff !important;
                }
                
                .bg-light {
                    background-color: #f8f9fa !important;
                }
                
                .text-center {
                    text-align: center !important;
                }
                
                .text-muted {
                    color: #6c757d !important;
                }
                
                .small {
                    font-size: 0.875em !important;
                }
                
                .mb-1 {
                    margin-bottom: 0.25rem !important;
                }
                
                .mb-0 {
                    margin-bottom: 0 !important;
                }
                
                .py-3 {
                    padding-top: 1rem !important;
                    padding-bottom: 1rem !important;
                }
                
                .mt-5 {
                    margin-top: 3rem !important;
                }
                
                .text-decoration-none {
                    text-decoration: none !important;
                }
                
                /* 移动端优化 */
                @media (max-width: 576px) {
                    .container { padding-left: 10px; padding-right: 10px; }
                    .card { padding: 0.75rem; margin-bottom: 0.75rem; }
                    .table td { padding: 0.5rem 0.25rem; font-size: 0.875rem; }
                    .btn { padding: 0.375rem 0.5rem; font-size: 0.875rem; }
                    .navbar-nav { flex-direction: column; }
                    .nav-item { margin-left: 0; margin-top: 0.5rem; }
                }
            `;
            document.head.appendChild(emergencyStyle);
        }
        
        // 页面加载完成后检测CSS
        window.addEventListener('load', checkCSSLoaded);
        
        // 也给CSS加载完成事件一个监听器
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkCSSLoaded, 1000); // 1秒后再次检查
        });
        
        // Service Worker 注册和更新管理
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(function(registration) {
                        console.log('Service Worker 注册成功:', registration.scope);
                        
                        // 检查Service Worker更新
                        registration.addEventListener('updatefound', function() {
                            const installingWorker = registration.installing;
                            console.log('发现新的Service Worker版本');
                            
                            installingWorker.addEventListener('statechange', function() {
                                if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 新版本已安装完成
                                    console.log('新Service Worker已安装，准备更新');
                                    
                                    // 显示更新提示
                                    if (confirm('发现新版本，是否立即更新？')) {
                                        // 立即激活新的Service Worker
                                        installingWorker.postMessage({type: 'SKIP_WAITING'});
                                        
                                        // 重新加载页面
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                        
                        // 定期检查更新（每5分钟）
                        setInterval(function() {
                            registration.update();
                        }, 5 * 60 * 1000);
                        
                    })
                    .catch(function(error) {
                        console.log('Service Worker 注册失败:', error);
                    });
            });
            
            // 监听Service Worker控制器变化
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', function() {
                if (!refreshing) {
                    refreshing = true;
                    console.log('Service Worker控制器已更新，重新加载页面');
                    window.location.reload();
                }
            });
            
            // 页面显示时检查Service Worker更新
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({type: 'CHECK_UPDATE'});
                }
            });
        }
        
        // 清理过期缓存的工具函数
        function clearExpiredCache() {
            if ('caches' in window) {
                caches.keys().then(function(cacheNames) {
                    return Promise.all(
                        cacheNames.map(function(cacheName) {
                            if (cacheName.startsWith('tangxiaozhu-') && 
                                cacheName !== 'tangxiaozhu-web-v2' && 
                                cacheName !== 'tangxiaozhu-static-v1' && 
                                cacheName !== 'tangxiaozhu-runtime-v1') {
                                console.log('清理过期缓存:', cacheName);
                                return caches.delete(cacheName);
                            }
                            return Promise.resolve();
                        })
                    );
                });
            }
        }
        
        // 每小时清理一次过期缓存
        setInterval(clearExpiredCache, 60 * 60 * 1000);
        
        // 页面加载时也清理一次
        window.addEventListener('load', clearExpiredCache);

        // Socket.IO 连接
        const socket = io();

        // 连接状态
        socket.on('connect', function() {
            console.log('已连接到服务器');
            // 连接成功时不显示通知，只在控制台记录
        });

        socket.on('disconnect', function() {
            console.log('与服务器断开连接');
            // 断开连接时不显示弹出提示
        });

        // 接收通知
        socket.on('notification', function(data) {
            showNotification(data.title + ': ' + data.message, 'info');

            // 浏览器通知
            if (Notification.permission === 'granted') {
                new Notification(data.title, {
                    body: data.message,
                    icon: '/static/icon-192.png',
                    badge: '/static/icon-192.png',
                    tag: 'nightscout-notification',
                    requireInteraction: true
                });
            }
        });
        
        // 显示通知函数
        function showNotification(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show notification-toast`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.getElementById('notification-area').appendChild(alertDiv);
            
            // 5秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // 同步数据函数
        function syncData() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 同步中...';
            btn.disabled = true;
            
            fetch('/api/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({days: 7})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 同步成功时不显示通知，只在控制台记录
                    console.log(`同步成功！获取到 ${data.glucose_count} 条血糖数据和 ${data.treatment_count} 条治疗数据`);
                    // 刷新页面数据
                    if (typeof loadData === 'function') {
                        loadData();
                    }
                } else {
                    showNotification('同步失败: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showNotification('同步失败: ' + error.message, 'danger');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
        
        // 订阅通知函数
        async function subscribeNotifications() {
            if (!('Notification' in window)) {
                showNotification('浏览器不支持通知功能', 'warning');
                return;
            }

            if (!('serviceWorker' in navigator)) {
                showNotification('浏览器不支持Service Worker', 'warning');
                return;
            }

            try {
                // 请求通知权限
                let permission = Notification.permission;
                if (permission === 'default') {
                    permission = await Notification.requestPermission();
                }

                if (permission !== 'granted') {
                    showNotification('通知权限被拒绝，请在浏览器设置中启用', 'warning');
                    return;
                }

                // 获取Service Worker注册
                const registration = await navigator.serviceWorker.ready;

                // 检查是否支持Push API
                if (!('PushManager' in window)) {
                    showNotification('浏览器不支持Push通知', 'warning');
                    return;
                }

                // 订阅Push通知
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array('YOUR_VAPID_PUBLIC_KEY') // 需要配置VAPID密钥
                });

                // 发送订阅信息到服务器
                const response = await fetch('/api/subscribe-push', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(subscription)
                });

                if (response.ok) {
                    socket.emit('subscribe_notifications', {});
                    showNotification('已订阅通知', 'success');
                } else {
                    showNotification('订阅失败，请稍后重试', 'danger');
                }

            } catch (error) {
                console.error('订阅通知失败:', error);
                // 降级到简单的浏览器通知
                if (Notification.permission === 'granted') {
                    socket.emit('subscribe_notifications', {});
                    showNotification('已订阅基础通知', 'success');
                } else {
                    showNotification('订阅失败: ' + error.message, 'danger');
                }
            }
        }

        // VAPID密钥转换函数
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        // 格式化血糖值显示
        function formatGlucoseValue(value) {
            if (value >= 13.9) {
                return `<span class="glucose-high">${value}</span>`;
            } else if (value >= 3.9 && value <= 10.0) {
                return `<span class="glucose-normal">${value}</span>`;
            } else {
                return `<span class="glucose-low">${value}</span>`;
            }
        }
        
        // 格式化方向箭头
        function formatDirection(direction) {
            const arrows = {
                'Flat': '→',
                'FortyFiveUp': '↗',
                'SingleUp': '↑',
                'DoubleUp': '↑↑',
                'FortyFiveDown': '↘',
                'SingleDown': '↓',
                'DoubleDown': '↓↓'
            };
            return `<span class="direction-arrow">${arrows[direction] || ''}</span>`;
        }
    </script>
    
    {% block extra_scripts %}{% endblock %}

    <!-- Footer -->
    <footer class="bg-light text-center text-muted py-3 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <p class="mb-1">
                        <i class="fas fa-heart text-danger"></i>
                        糖小助 - 让血糖管理更简单
                    </p>
                    <p class="mb-0 small">
                        作者: <a href="https://www.llingfei.com" target="_blank" class="text-decoration-none">flynn</a> |
                        <span class="text-muted">专业的血糖监控解决方案</span>
                    </p>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
