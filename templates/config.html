{% extends "base.html" %}

{% block title %}配置 - Nightscout 血糖监控{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog"></i> 系统配置
                </h5>
            </div>
            <div class="card-body">
                <form id="config-form">
                    <!-- Nightscout 配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-link"></i> Nightscout 配置
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="ns-api-url" class="form-label">API 地址 *</label>
                                        <input type="url" class="form-control" id="ns-api-url" 
                                               value="{{ config.nightscout.api_url }}" 
                                               placeholder="https://your-nightscout-site.com" required>
                                        <div class="form-text">您的 Nightscout 网站地址</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="ns-timezone" class="form-label">时区偏移</label>
                                        <input type="number" class="form-control" id="ns-timezone" 
                                               value="{{ config.nightscout.timezone_offset }}" 
                                               min="-12" max="12" step="1">
                                        <div class="form-text">相对于 UTC 的小时数</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="ns-api-key" class="form-label">API 密钥</label>
                                <input type="password" class="form-control" id="ns-api-key" 
                                       value="{{ config.nightscout.api_key }}" 
                                       placeholder="通常不需要填写">
                                <div class="form-text">如果您的 Nightscout 需要认证，请填写 API 密钥</div>
                            </div>
                        </div>
                    </div>

                    <!-- 个人信息 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-user"></i> 个人信息
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="height-cm" class="form-label">身高 (cm)</label>
                                        <input type="number" class="form-control" id="height-cm"
                                               value="{{ config.basic.height_cm }}"
                                               min="0" step="0.1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="weight-kg" class="form-label">体重 (kg)</label>
                                        <input type="number" class="form-control" id="weight-kg"
                                               value="{{ config.basic.weight_kg }}"
                                               min="0" step="0.1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">BMI</label>
                                        <div id="bmi-display" class="form-control-plaintext">--</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="body-fat" class="form-label">体脂率 (%)</label>
                                        <input type="number" class="form-control" id="body-fat"
                                               value="{{ config.basic.body_fat_percentage }}"
                                               min="0" max="100" step="0.1">
                                        <div class="form-text">可选，用于更精准的AI分析</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 治疗方案配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-pills"></i> 治疗方案配置
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- 药物治疗 -->
                            <div class="mb-4">
                                <h6 class="mb-3">药物治疗</h6>
                                <div id="medications-container">
                                    <div class="medication-item mb-3 p-3 border rounded">
                                        <div class="row align-items-center">
                                            <div class="col-md-3">
                                                <input type="text" class="form-control medication-name" 
                                                       placeholder="药物名称" value="">
                                            </div>
                                            <div class="col-md-2">
                                                <input type="text" class="form-control medication-dosage" 
                                                       placeholder="剂量" value="">
                                            </div>
                                            <div class="col-md-2">
                                                <input type="text" class="form-control medication-unit" 
                                                       placeholder="单位" value="mg">
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-select medication-usage">
                                                    <option value="">选择用法</option>
                                                    <option value="一日三次">一日三次</option>
                                                    <option value="早晚一次">早晚一次</option>
                                                    <option value="每日一次">每日一次</option>
                                                    <option value="每日随餐">每日随餐</option>
                                                    <option value="custom">自定义</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-danger btn-sm remove-medication" 
                                                        onclick="removeMedication(this)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2 custom-usage-row" style="display: none;">
                                            <div class="col-md-12">
                                                <input type="text" class="form-control medication-custom-usage" 
                                                       placeholder="请输入自定义用法">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-outline-primary" onclick="addMedication()">
                                        <i class="fas fa-plus"></i> 添加药物
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearMedications()">
                                        <i class="fas fa-eraser"></i> 清空所有
                                    </button>
                                </div>
                            </div>

                            <!-- 胰岛素注射 -->
                            <div class="mb-3">
                                <h6 class="mb-3">胰岛素注射</h6>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="insulin-enabled" 
                                           {% if config.treatment_plan.insulin_enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="insulin-enabled">
                                        是否注射胰岛素
                                    </label>
                                </div>
                                <div id="insulin-details" style="{% if not config.treatment_plan.insulin_enabled %}display: none;{% endif %}">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="insulin-dosage" class="form-label">注射剂量</label>
                                                <input type="number" class="form-control" id="insulin-dosage" 
                                                       value="{{ config.treatment_plan.insulin_dosage }}" 
                                                       min="0" step="0.1" placeholder="单位">
                                                <div class="form-text">每次注射的胰岛素剂量</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="insulin-frequency" class="form-label">注射次数</label>
                                                <select class="form-select" id="insulin-frequency">
                                                    <option value="">选择注射次数</option>
                                                    <option value="每日一次" {% if config.treatment_plan.insulin_frequency == '每日一次' %}selected{% endif %}>每日一次</option>
                                                    <option value="每日两次" {% if config.treatment_plan.insulin_frequency == '每日两次' %}selected{% endif %}>每日两次</option>
                                                    <option value="每日三次" {% if config.treatment_plan.insulin_frequency == '每日三次' %}selected{% endif %}>每日三次</option>
                                                    <option value="每日四次" {% if config.treatment_plan.insulin_frequency == '每日四次' %}selected{% endif %}>每日四次</option>
                                                    <option value="custom">自定义</option>
                                                </select>
                                                <div class="form-text">每日注射胰岛素的次数</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row custom-frequency-row" style="{% if config.treatment_plan.insulin_frequency != 'custom' %}display: none;{% endif %}">
                                        <div class="col-md-12">
                                            <input type="text" class="form-control" id="insulin-custom-frequency" 
                                                   value="{{ config.treatment_plan.insulin_custom_frequency }}" 
                                                   placeholder="请输入自定义注射次数">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI 配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-brain"></i> AI 分析配置
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ai-api-url" class="form-label">AI API 地址</label>
                                        <input type="url" class="form-control" id="ai-api-url" 
                                               value="{{ config.ai_config.api_url }}" 
                                               placeholder="http://localhost:11434/v1/chat/completions">
                                        <div class="form-text">支持 OpenAI 兼容的 API</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ai-model" class="form-label">模型名称</label>
                                        <input type="text" class="form-control" id="ai-model" 
                                               value="{{ config.ai_config.model_name }}" 
                                               placeholder="llama3.1:8b">
                                        <div class="form-text">AI 模型名称</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ai-api-key" class="form-label">API 密钥</label>
                                        <input type="password" class="form-control" id="ai-api-key" 
                                               value="{{ config.ai_config.api_key }}" 
                                               placeholder="如果需要认证请填写">
                                        <div class="form-text">OpenAI API 密钥或其他服务的认证密钥</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ai-timeout" class="form-label">超时时间 (秒)</label>
                                        <input type="number" class="form-control" id="ai-timeout" 
                                               value="{{ config.ai_config.timeout }}" 
                                               min="10" max="120" step="5">
                                        <div class="form-text">AI 请求的超时时间</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-info" onclick="testAIConnection()">
                                            <i class="fas fa-brain"></i> 测试 AI 连接
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> 暂不支持思维模型
                            </div>
                        </div>
                    </div>

                    <!-- 定时任务配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-clock"></i> 定时任务配置
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enable-auto-analysis" 
                                                   {% if config.schedule.enable_auto_analysis %}checked{% endif %}>
                                            <label class="form-check-label" for="enable-auto-analysis">
                                                启用定时分析
                                            </label>
                                        </div>
                                        <div class="form-text">自动进行血糖分析并发送通知</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="sync-interval" class="form-label">同步间隔 (分钟)</label>
                                        <input type="number" class="form-control" id="sync-interval" 
                                               value="{{ config.schedule.sync_interval_minutes }}" 
                                               min="5" max="60" step="5">
                                        <div class="form-text">自动同步数据的间隔时间</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="analysis-times" class="form-label">分析时间点</label>
                                <input type="text" class="form-control" id="analysis-times" 
                                       value="{{ config.schedule.analysis_times | join(', ') }}" 
                                       placeholder="10:00, 15:00, 21:00">
                                <div class="form-text">每日自动分析的时间点，用逗号分隔 (24小时制)</div>
                            </div>
                        </div>
                    </div>

                    <!-- 通知配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-bell"></i> 通知配置
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enable-web-push" 
                                                   {% if config.notification.enable_web_push %}checked{% endif %}>
                                            <label class="form-check-label" for="enable-web-push">
                                                启用浏览器推送通知
                                            </label>
                                        </div>
                                        <div class="form-text">在浏览器中显示推送通知</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enable-email" 
                                                   {% if config.notification.enable_email %}checked{% endif %}>
                                            <label class="form-check-label" for="enable-email">
                                                启用邮件通知
                                            </label>
                                        </div>
                                        <div class="form-text">通过邮件发送分析报告</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 新增的血糖报警范围配置 -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="high-glucose-threshold" class="form-label">高血糖报警阈值 (mmol/L)</label>
                                        <input type="number" class="form-control" id="high-glucose-threshold" 
                                               value="{{ config.alert.high_glucose_threshold or 10.0 }}" 
                                               min="1.0" max="30.0" step="0.1" placeholder="10.0">
                                        <div class="form-text">高于此值时触发高血糖报警 (示例: 10.0)</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="low-glucose-threshold" class="form-label">低血糖报警阈值 (mmol/L)</label>
                                        <input type="number" class="form-control" id="low-glucose-threshold" 
                                               value="{{ config.alert.low_glucose_threshold or 3.9 }}" 
                                               min="1.0" max="30.0" step="0.1" placeholder="3.9">
                                        <div class="form-text">低于此值时触发低血糖报警 (示例: 3.9)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 新增的报警邮箱通知开关 -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enable-email-alerts" 
                                                   {% if config.alert.enable_email_alerts %}checked{% endif %}>
                                            <label class="form-check-label" for="enable-email-alerts">
                                                启用血糖报警邮箱通知
                                            </label>
                                        </div>
                                        <div class="form-text">血糖预测报警时发送邮件通知</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 邮件配置 -->
                    <div class="card mb-4" id="email-config" style="{% if not config.notification.enable_email %}display: none;{% endif %}">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-envelope"></i> 邮件配置
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtp-server" class="form-label">SMTP 服务器 *</label>
                                        <input type="text" class="form-control" id="smtp-server" 
                                               value="{{ config.email.smtp_server }}" 
                                               placeholder="smtp.gmail.com">
                                        <div class="form-text">邮件服务器地址</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtp-port" class="form-label">SMTP 端口</label>
                                        <input type="number" class="form-control" id="smtp-port" 
                                               value="{{ config.email.smtp_port }}" 
                                               placeholder="587">
                                        <div class="form-text">通常为 587 (TLS) 或 465 (SSL)</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtp-username" class="form-label">用户名 *</label>
                                        <input type="text" class="form-control" id="smtp-username" 
                                               value="{{ config.email.smtp_username }}" 
                                               placeholder="your-email@gmail.com">
                                        <div class="form-text">SMTP 认证用户名</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtp-password" class="form-label">密码 *</label>
                                        <input type="password" class="form-control" id="smtp-password" 
                                               value="{{ config.email.smtp_password }}" 
                                               placeholder="应用专用密码">
                                        <div class="form-text">SMTP 认证密码</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="from-email" class="form-label">发件人邮箱 *</label>
                                        <input type="email" class="form-control" id="from-email" 
                                               value="{{ config.email.from_email }}" 
                                               placeholder="your-email@gmail.com">
                                        <div class="form-text">发送邮件的邮箱地址</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="to-emails" class="form-label">收件人邮箱 *</label>
                                        <input type="text" class="form-control" id="to-emails" 
                                               value="{{ config.email.to_emails | join(', ') }}" 
                                               placeholder="email1@example.com, email2@example.com">
                                        <div class="form-text">接收通知的邮箱地址，多个用逗号分隔</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 认证配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-shield-alt"></i> 认证配置
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auth-enable" {% if config.auth.enable %}checked{% endif %}>
                                    <label class="form-check-label" for="auth-enable">启用密码保护</label>
                                </div>
                                <div class="form-text">启用后，访问网站需要输入密码。</div>
                            </div>
                            <div id="password-fields" style="{% if not config.auth.enable %}display: none;{% endif %}">
                                <div class="mb-3">
                                    <label for="auth-password" class="form-label">新密码</label>
                                    <input type="password" class="form-control" id="auth-password" placeholder="留空则不修改">
                                    <div class="form-text">设置一个新的访问密码。</div>
                                </div>
                                <div class="mb-3">
                                    <label for="auth-password-confirm" class="form-label">确认新密码</label>
                                    <input type="password" class="form-control" id="auth-password-confirm" placeholder="再次输入新密码">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="button" class="btn btn-info" onclick="testNightscoutConnection()">
                                <i class="fas fa-link"></i> 测试 Nightscout 连接
                            </button>
                            <button type="button" class="btn btn-warning" onclick="testEmailConfig()">
                                <i class="fas fa-envelope"></i> 测试邮件配置
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary" onclick="resetConfig()">
                                <i class="fas fa-undo"></i> 重置
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 保存配置
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // 认证配置显示/隐藏
    document.getElementById('auth-enable').addEventListener('change', function() {
        const passwordFields = document.getElementById('password-fields');
        if (this.checked) {
            passwordFields.style.display = 'block';
        } else {
            passwordFields.style.display = 'none';
        }
    });

    // 邮件配置显示/隐藏
    document.getElementById('enable-email').addEventListener('change', function() {
        const emailConfig = document.getElementById('email-config');
        if (this.checked) {
            emailConfig.style.display = 'block';
        } else {
            emailConfig.style.display = 'none';
        }
    });
    
    // 保存配置
    document.getElementById('config-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const password = document.getElementById('auth-password').value;
        const passwordConfirm = document.getElementById('auth-password-confirm').value;

        if (password !== passwordConfirm) {
            showNotification('两次输入的密码不一致', 'danger');
            return;
        }

        // 获取药物治疗数据
        const medications = getMedicationsData();
        
        const config = {
            auth: {
                enable: document.getElementById('auth-enable').checked,
                password: password
            },
            basic: {
                enable: true,
                timezone_offset: parseInt(document.getElementById('ns-timezone').value),
                height_cm: parseFloat(document.getElementById('height-cm').value) || 0,
                weight_kg: parseFloat(document.getElementById('weight-kg').value) || 0,
                body_fat_percentage: parseFloat(document.getElementById('body-fat').value) || 0
            },
            nightscout: {
                api_url: document.getElementById('ns-api-url').value.trim(),
                api_key: document.getElementById('ns-api-key').value.trim(),
                timezone_offset: parseInt(document.getElementById('ns-timezone').value)
            },
            ai_config: {
                api_url: document.getElementById('ai-api-url').value.trim(),
                api_key: document.getElementById('ai-api-key').value.trim(),
                model_name: document.getElementById('ai-model').value.trim(),
                timeout: parseInt(document.getElementById('ai-timeout').value)
            },
            schedule: {
                analysis_times: document.getElementById('analysis-times').value.split(',').map(t => t.trim()).filter(t => t),
                enable_auto_analysis: document.getElementById('enable-auto-analysis').checked,
                sync_interval_minutes: parseInt(document.getElementById('sync-interval').value)
            },
            notification: {
                enable_web_push: document.getElementById('enable-web-push').checked,
                enable_email: document.getElementById('enable-email').checked
            },
            email: {
                smtp_server: document.getElementById('smtp-server').value.trim(),
                smtp_port: parseInt(document.getElementById('smtp-port').value),
                smtp_username: document.getElementById('smtp-username').value.trim(),
                smtp_password: document.getElementById('smtp-password').value.trim(),
                from_email: document.getElementById('from-email').value.trim(),
                to_emails: document.getElementById('to-emails').value.split(',').map(e => e.trim()).filter(e => e)
            },
            treatment_plan: {
                medications: medications,
                insulin_enabled: document.getElementById('insulin-enabled').checked,
                insulin_dosage: parseFloat(document.getElementById('insulin-dosage').value) || 0,
                insulin_frequency: document.getElementById('insulin-frequency').value,
                insulin_custom_frequency: document.getElementById('insulin-custom-frequency').value.trim()
            },
            alert: {
                high_glucose_threshold: parseFloat(document.getElementById('high-glucose-threshold').value) || 10.0,
                low_glucose_threshold: parseFloat(document.getElementById('low-glucose-threshold').value) || 3.9,
                enable_email_alerts: document.getElementById('enable-email-alerts').checked
            }
        };
        
        // 验证血糖报警阈值
        const highThreshold = config.alert.high_glucose_threshold;
        const lowThreshold = config.alert.low_glucose_threshold;
        
        if (highThreshold <= lowThreshold) {
            showNotification('高血糖阈值必须大于低血糖阈值', 'danger');
            return;
        }
        
        if (highThreshold < 1.0 || highThreshold > 30.0 || lowThreshold < 1.0 || lowThreshold > 30.0) {
            showNotification('血糖阈值必须在1.0-30.0 mmol/L范围内', 'danger');
            return;
        }
        
        // 验证必填字段
        if (!config.nightscout.api_url) {
            showNotification('请填写 Nightscout API 地址', 'danger');
            return;
        }
        
        if (config.notification.enable_email) {
            if (!config.email.smtp_server || !config.email.smtp_username || 
                !config.email.smtp_password || !config.email.from_email || 
                config.email.to_emails.length === 0) {
                showNotification('启用邮件通知时，请填写完整的邮件配置', 'danger');
                return;
            }
        }
        
        // 保存配置
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
        submitBtn.disabled = true;
        
        fetch('/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('配置保存成功', 'success');
            } else {
                showNotification('配置保存失败: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showNotification('配置保存失败: ' + error.message, 'danger');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
    
    // 测试 Nightscout 连接
    function testNightscoutConnection() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
        btn.disabled = true;
        
        fetch('/api/test-connection', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
            } else {
                showNotification(data.message, 'danger');
            }
        })
        .catch(error => {
            showNotification('测试失败: ' + error.message, 'danger');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    // 测试邮件配置
    function testEmailConfig() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
        btn.disabled = true;

        // 创建AbortController用于取消请求
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30秒超时

        fetch('/api/test-email', {
            method: 'POST',
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showNotification('邮件测试成功', 'success');
            } else {
                showNotification(data.error || '邮件测试失败', 'danger');
            }
        })
        .catch(error => {
            if (error.name === 'AbortError') {
                showNotification('测试超时，请检查网络连接或邮件服务器设置', 'warning');
            } else {
                showNotification('测试失败: ' + error.message, 'danger');
            }
        })
        .finally(() => {
            clearTimeout(timeoutId);
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    // 测试 AI 连接
    function testAIConnection() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
        btn.disabled = true;
        
        // 获取当前配置的 AI 参数
        const apiUrl = document.getElementById('ai-api-url').value.trim();
        const apiKey = document.getElementById('ai-api-key').value.trim();
        const modelName = document.getElementById('ai-model').value.trim();
        const timeout = parseInt(document.getElementById('ai-timeout').value) || 30;
        
        if (!apiUrl) {
            showNotification('请先填写 AI API 地址', 'danger');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }
        
        if (!modelName) {
            showNotification('请先填写模型名称', 'danger');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }
        
        // 发送测试请求
        fetch('/api/test-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                api_url: apiUrl,
                api_key: apiKey,
                model_name: modelName,
                timeout: timeout
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('AI 连接测试成功: ' + data.message, 'success');
            } else {
                showNotification('AI 连接测试失败: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showNotification('AI 连接测试失败: ' + error.message, 'danger');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    // 重置配置
    function resetConfig() {
        if (confirm('确定要重置所有配置吗？')) {
            location.reload();
        }
    }

    // BMI 计算和显示
    function calculateAndDisplayBMI() {
        const heightInput = document.getElementById('height-cm');
        const weightInput = document.getElementById('weight-kg');
        const bmiDisplay = document.getElementById('bmi-display');

        const height = parseFloat(heightInput.value);
        const weight = parseFloat(weightInput.value);

        if (height > 0 && weight > 0) {
            const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
            let status = '';
            let statusClass = '';

            if (bmi < 18.5) {
                status = '偏瘦';
                statusClass = 'text-warning';
            } else if (bmi < 24) {
                status = '正常';
                statusClass = 'text-success';
            } else if (bmi < 28) {
                status = '超重';
                statusClass = 'text-warning';
            } else {
                status = '肥胖';
                statusClass = 'text-danger';
            }
            bmiDisplay.innerHTML = `${bmi} <span class="badge ${statusClass}">${status}</span>`;
        } else {
            bmiDisplay.textContent = '--';
        }
    }

    document.getElementById('height-cm').addEventListener('input', calculateAndDisplayBMI);
    document.getElementById('weight-kg').addEventListener('input', calculateAndDisplayBMI);
    
    // 页面加载时计算一次
    document.addEventListener('DOMContentLoaded', calculateAndDisplayBMI);

    // 治疗方案配置相关函数
    document.addEventListener('DOMContentLoaded', function() {
        // 胰岛素启用/禁用切换
        document.getElementById('insulin-enabled').addEventListener('change', function() {
            const insulinDetails = document.getElementById('insulin-details');
            if (this.checked) {
                insulinDetails.style.display = 'block';
            } else {
                insulinDetails.style.display = 'none';
            }
        });

        // 胰岛素注射频率选择
        document.getElementById('insulin-frequency').addEventListener('change', function() {
            const customFrequencyRow = document.querySelector('.custom-frequency-row');
            if (this.value === 'custom') {
                customFrequencyRow.style.display = 'block';
            } else {
                customFrequencyRow.style.display = 'none';
            }
        });

        // 初始化胰岛素频率显示状态
        const insulinFrequency = document.getElementById('insulin-frequency');
        const customFrequencyRow = document.querySelector('.custom-frequency-row');
        if (insulinFrequency.value === 'custom') {
            customFrequencyRow.style.display = 'block';
        } else {
            customFrequencyRow.style.display = 'none';
        }

        // 药物用法选择事件委托
        document.getElementById('medications-container').addEventListener('change', function(e) {
            if (e.target.classList.contains('medication-usage')) {
                const medicationItem = e.target.closest('.medication-item');
                const customUsageRow = medicationItem.querySelector('.custom-usage-row');
                
                if (e.target.value === 'custom') {
                    customUsageRow.style.display = 'block';
                } else {
                    customUsageRow.style.display = 'none';
                }
            }
        });

        // 加载已保存的药物治疗数据
        loadMedications();
    });

    // 添加药物
    function addMedication() {
        addMedicationWithData('', '', 'mg', '');
    }

    // 删除药物
    function removeMedication(button) {
        const medicationItem = button.closest('.medication-item');
        medicationItem.remove();
    }

    // 清空所有药物
    function clearMedications() {
        if (confirm('确定要清空所有药物记录吗？')) {
            document.getElementById('medications-container').innerHTML = '';
            // 重新添加一个空的药物项
            addMedication();
        }
    }

    // 加载药物治疗数据
    function loadMedications() {
        // 从服务器配置中加载已保存的药物治疗数据
        const container = document.getElementById('medications-container');
        container.innerHTML = ''; // 清空容器
        
        // 获取已保存的药物治疗数据
        const savedMedications = {{ config.treatment_plan.medications|tojson|safe }};
        
        if (savedMedications && savedMedications.length > 0) {
            // 加载已保存的药物
            savedMedications.forEach(med => {
                addMedicationWithData(med.name, med.dosage, med.unit, med.usage);
            });
        } else {
            // 如果没有保存的数据，添加一个空的药物项
            addMedication();
        }
    }

    // 添加药物并填充数据
    function addMedicationWithData(name, dosage, unit, usage) {
        const container = document.getElementById('medications-container');
        const medicationItem = document.createElement('div');
        medicationItem.className = 'medication-item mb-3 p-3 border rounded';
        
        medicationItem.innerHTML = `
            <div class="row align-items-center">
                <div class="col-md-3">
                    <input type="text" class="form-control medication-name" 
                           placeholder="药物名称" value="${name || ''}">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control medication-dosage" 
                           placeholder="剂量" value="${dosage || ''}">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control medication-unit" 
                           placeholder="单位" value="${unit || 'mg'}">
                </div>
                <div class="col-md-3">
                    <select class="form-select medication-usage">
                        <option value="">选择用法</option>
                        <option value="一日三次" ${usage === '一日三次' ? 'selected' : ''}>一日三次</option>
                        <option value="早晚一次" ${usage === '早晚一次' ? 'selected' : ''}>早晚一次</option>
                        <option value="每日一次" ${usage === '每日一次' ? 'selected' : ''}>每日一次</option>
                        <option value="每日随餐" ${usage === '每日随餐' ? 'selected' : ''}>每日随餐</option>
                        <option value="custom" ${usage && !['一日三次', '早晚一次', '每日一次', '每日随餐'].includes(usage) ? 'selected' : ''}>自定义</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm remove-medication" 
                            onclick="removeMedication(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-2 custom-usage-row" style="${usage && !['一日三次', '早晚一次', '每日一次', '每日随餐'].includes(usage) ? 'display: block;' : 'display: none;'}">
                <div class="col-md-12">
                    <input type="text" class="form-control medication-custom-usage" 
                           placeholder="请输入自定义用法" value="${usage && !['一日三次', '早晚一次', '每日一次', '每日随餐'].includes(usage) ? usage : ''}">
                </div>
            </div>
        `;
        
        container.appendChild(medicationItem);
    }

    // 获取药物治疗数据
    function getMedicationsData() {
        const medications = [];
        const medicationItems = document.querySelectorAll('.medication-item');
        
        medicationItems.forEach(item => {
            const name = item.querySelector('.medication-name').value.trim();
            const dosage = item.querySelector('.medication-dosage').value.trim();
            const unit = item.querySelector('.medication-unit').value.trim();
            const usageSelect = item.querySelector('.medication-usage');
            const customUsage = item.querySelector('.medication-custom-usage').value.trim();
            
            if (name && dosage) {
                let usage = usageSelect.value;
                if (usage === 'custom' && customUsage) {
                    usage = customUsage;
                }
                
                medications.push({
                    name: name,
                    dosage: dosage,
                    unit: unit,
                    usage: usage || ''
                });
            }
        });
        
        return medications;
    }

    </script>
{% endblock %}
